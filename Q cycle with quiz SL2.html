<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Q Cycle in Cytochrome b6f Complex</title>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; /* Changed to 100vh for full page background */
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            width: 100%; /* Ensure container is responsive */
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 1.2em;
        }

        .intro-text {
            margin-bottom: 30px;
            padding: 15px 20px;
            background: #f0f4f8;
            border-left: 44px solid #667eea;
            border-radius: 8px;
            line-height: 1.6;
            color: #333;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        .intro-text h2 {
            color: #2c3e50;
            margin-top: 0;
            font-size: 1.5em;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .intro-text ul {
            list-style: disc;
            margin-left: 20px;
            padding: 0;
        }

        .intro-text ul li {
            margin-bottom: 8px;
        }


        .diagram-container {
            position: relative;
            width: 100%;
            max-width: 900px; /* Limit max width for better appearance */
            height: 600px; /* Base height for desktop */
            background: linear-gradient(180deg, #e8f5e8 0%, #f0f8ff 50%, #fff8e1 100%);
            border: 3px solid #34495e;
            border-radius: 15px;
            margin: 20px auto; /* Center the diagram */
            overflow: hidden;
            box-shadow: inset 0 5px 15px (0,0,0,0.1);
        }

        .membrane {
            position: absolute;
            width: 100%;
            height: 80px; /* Double the previous 40px height */
            background: linear-gradient(90deg, #8b4513, #cd853f, #8b4513);
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            z-index: 2; /* Ensure membrane is above certain elements */
        }
        
        .membrane-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); /* Centered vertically within the membrane */
            color: white;
            font-weight: bold;
            font-size: 14px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            z-index: 3;
            white-space: nowrap;
        }

        .complex {
            position: absolute;
            width: 200px;
            height: 250px; /* Adjusted height for better spacing of sites */
            background: linear-gradient(45deg, #2c3e50, #34495e);
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            border: 2px solid #1a252f;
            z-index: 3;
        }

        .complex-label {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: #e74c3c;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            white-space: nowrap; /* Prevent label from wrapping */
        }
        
        /* Sub-complexes/Sites within b6f complex */
        .rieske, .cyt-bL, .cyt-bH, .cyt-f {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 10px;
            padding: 2px 5px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            text-align: center;
        }

        .rieske { top: 20px; left: 20px; width: 60px; height: 20px; }
        .cyt-bL { top: 50px; left: 120px; width: 60px; height: 20px; }
        .cyt-bH { top: 120px; left: 120px; width: 60px; height: 20px; }
        .cyt-f { top: 90px; left: 20px; width: 60px; height: 20px; }


        .binding-site {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 3px solid #fff;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 4;
        }

        .binding-site:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
        }

        /* Swapped Qo and Qi positions */
        .qo-site {
            background: #e67e22; /* Lumenal side color */
            bottom: 50px; /* Now on the bottom (lumen side) */
            left: 50%;
            transform: translateX(-50%);
        }

        .qi-site {
            background: #27ae60; /* Stromal side color */
            top: 50px; /* Now on the top (stromal side) */
            left: 50%;
            transform: translateX(-50%);
        }

        .plastoquinone {
            position: absolute;
            width: 40px; /* Larger for better visibility */
            height: 40px;
            background: #f39c12;
            border-radius: 50%;
            border: 2px solid #d68910;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
            transition: all 2s ease-in-out; /* Slower animation */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: white;
            z-index: 5;
        }

        .plastocyanin {
            position: absolute;
            width: 45px; /* Larger for better visibility */
            height: 45px;
            background: #3498db;
            border-radius: 50%;
            border: 3px solid #2980b9;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            color: white;
            transition: all 2s ease-in-out; /* Slower animation */
            z-index: 15; /* Increased z-index for visibility */
        }

        .electron {
            position: absolute;
            width: 18px; /* Slightly larger for text */
            height: 18px; /* Slightly larger for text */
            background: #e74c3c;
            border-radius: 50%;
            box-shadow: 0 0 10px #e74c3c, 0 0 20px #e74c3c;
            transition: all 3s ease-in-out; /* Even Slower animation */
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px; /* Font size for 'e‚Åª' */
            font-weight: bold;
            color: white;
        }

        .proton {
            position: absolute;
            width: 18px; /* Larger for better visibility */
            height: 18px;
            background: #9b59b6;
            border-radius: 50%;
            box-shadow: 0 0 8px #9b59b6, 0 0 15px #9b59b6;
            transition: all 2s ease-in-out; /* Slower animation */
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
            font-weight: bold;
        }

        .photosystem { /* Unified styling for Photosystem I and II */
            position: absolute;
            width: 100px;
            height: 80px; /* Same height as membrane for embedding */
            background: linear-gradient(45deg, #1abc9c, #16a085);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            text-align: center;
            transition: all 0.8s ease-in-out;
            z-index: 3; /* Increased z-index to be visible above membrane */
        }


        .controls {
            text-align: center;
            margin: 30px 0;
            display: flex;
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
            justify-content: center;
            gap: 15px; /* Spacing between buttons */
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            font-weight: bold;
            min-width: 120px; /* Ensure buttons have a minimum width */
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* Styles for the new flow chart */
        .step-info-container {
            margin: 20px auto; /* Center it */
            max-width: 900px; /* Match diagram container width */
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            border-left: 5px solid #667eea;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            display: flex; /* Make it a flex container for the flow chart */
            flex-direction: column; /* Stack flow chart elements vertically */
            align-items: center; /* Center items horizontally */
        }

        .step-flow-chart {
            display: flex;
            flex-direction: column; /* Stack steps vertically */
            align-items: center; /* Center individual steps */
            gap: 15px; /* Space between steps */
            padding: 10px;
            width: 100%; /* Take full width of container */
        }

        .flow-step {
            width: 90%; /* Steps take up most of the width */
            background: #ffffff;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            text-align: left;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            opacity: 0.6; /* Dim inactive steps */
            transform: scale(0.95); /* Slightly scale down inactive steps */
            position: relative;
        }

        .flow-step.active-flow-step {
            opacity: 1;
            transform: scale(1);
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            background: #e6f0ff; /* Light blue background for active */
        }

        .flow-step.completed-flow-step {
            opacity: 0.8;
            background: #e2f5e2; /* Light green for completed */
            border-color: #27ae60;
        }

        .flow-step-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
            font-size: 1.1em;
        }

        .flow-step-description {
            font-size: 0.9em;
            color: #555;
        }

        .flow-connector {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            color: #667eea;
            font-weight: bold;
            margin: 5px 0; /* Vertical margin for vertical arrows */
            user-select: none;
        }


        .phase-indicator {
            position: absolute;
            top: 10px;
            right: 20px;
            background: #34495e;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            z-index: 10;
        }

        /* Styles for the labels (Stroma and Lumen) */
        .labels {
            position: absolute;
            padding: 8px 15px; /* Slightly more padding */
            background: rgba(255, 255, 255, 0.9); /* More opaque background */
            border-radius: 10px; /* More rounded */
            font-weight: bold;
            z-index: 10;
            white-space: nowrap;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15); /* Stronger shadow */
            font-size: 1.1em; /* Increased font size */
        }

        .stroma-label {
            top: 20px;
            left: 20px;
            color: #34495e; /* Darker, more prominent color */
        }

        .lumen-label {
            bottom: 20px;
            right: 20px;
            color: #34495e; /* Darker, more prominent color */
        }

        .membrane-bottom-label {
            position: absolute;
            bottom: calc(50% - 40px - 20px); /* Adjust based on membrane height (80px) and desired offset */
            right: 20px; /* Position to the right */
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            font-weight: bold;
            z-index: 10;
            white-space: nowrap;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            font-size: 1.1em;
            color: #34495e;
            transform: translateY(100%); /* Position exactly below the membrane's bottom edge */
        }

        /* Summary points styling */
        .summary-container {
            display: none; /* Hidden by default, shown after animation completes */
            margin: 30px auto;
            max-width: 900px;
            background: #ffffff;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }

        .summary-container h2 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 2em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
            position: relative;
        }
        .summary-container h2::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 4px;
            background: #764ba2;
            border-radius: 5px;
        }

        .summary-section {
            margin-bottom: 25px;
        }

        .summary-section h3 {
            color: #34495e;
            font-size: 1.5em;
            margin-bottom: 15px;
            border-left: 5px solid #3498db;
            padding-left: 10px;
        }

        .summary-section ul {
            list-style: none; /* Remove default bullet points */
            padding: 0;
            margin: 0;
        }

        .summary-section ul li {
            background: #f8f9fa;
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            display: flex;
            align-items: flex-start;
            line-height: 1.5;
            color: #444;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .summary-section ul li::before {
            content: '‚Ä¢'; /* Custom bullet point */
            color: #667eea;
            font-weight: bold;
            display: inline-block;
            width: 1.2em;
            margin-left: -1.2em;
            margin-right: 0.5em;
            flex-shrink: 0;
        }

        .summary-section ul li strong {
            color: #2c3e50;
        }

        /* Quiz specific styles */
        .quiz-container {
            display: none; /* Hidden by default, shown after summary notes */
            margin: 30px auto;
            max-width: 900px;
            background: #ffffff;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }

        .quiz-container h2 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 2em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
            position: relative;
        }
        .quiz-container h2::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 4px;
            background: #764ba2;
            border-radius: 5px;
        }

        .question-item {
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .question-item p.question-text {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1em;
            line-height: 1.4;
        }

        .options label {
            display: block;
            margin-bottom: 8px;
            cursor: pointer;
            padding: 8px 10px;
            border-radius: 5px;
            transition: background-color 0.2s ease;
        }

        .options label:hover {
            background-color: #eef2f6;
        }

        .options input[type="radio"] {
            margin-right: 10px;
            transform: scale(1.1);
        }

        .answer-feedback {
            margin-top: 10px;
            font-weight: bold;
            display: none; /* Hidden by default */
        }

        .answer-feedback.correct {
            color: green;
        }

        .answer-feedback.incorrect {
            color: red;
        }

        .quiz-controls {
            text-align: center;
            margin-top: 30px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                align-items: flex-start;
            }

            .container {
                padding: 15px;
                border-radius: 10px;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            }

            h1 {
                font-size: 1.6em;
                margin-bottom: 5px;
            }

            .subtitle {
                font-size: 0.9em;
                margin-bottom: 15px;
            }

            .intro-text {
                margin-bottom: 20px;
                padding: 10px 15px;
            }
            .intro-text h2 {
                font-size: 1.2em;
                margin-bottom: 10px;
            }
            .intro-text ul {
                margin-left: 15px;
                font-size: 0.9em;
            }


            .diagram-container {
                height: 400px;
                max-height: 60vh;
                border-radius: 10px;
                margin: 15px auto;
            }

            .membrane {
                height: 60px;
            }

            .membrane-label {
                font-size: 12px;
            }
            
            .complex {
                width: 140px;
                height: 180px;
                border-radius: 10px;
            }
            .complex-label {
                font-size: 12px;
                padding: 3px 10px;
                top: -20px;
            }
            .rieske, .cyt-bL, .cyt-bH, .cyt-f {
                font-size: 8px;
                width: 45px;
                height: 16px;
                padding: 1px 3px;
            }
            .rieske { top: 15px; left: 15px; }
            .cyt-bL { top: 40px; left: 90px; }
            .cyt-bH { top: 100px; left: 90px; }
            .cyt-f { top: 75px; left: 15px; }

            .binding-site {
                width: 25px;
                height: 25px;
                font-size: 8px;
            }
            .qo-site {
                bottom: 30px;
            }
            .qi-site {
                top: 30px;
            }

            .plastoquinone, .plastocyanin {
                width: 35px;
                height: 35px;
                font-size: 10px;
            }

            .electron, .proton {
                width: 15px;
                height: 15px;
                font-size: 8px;
            }

            .photosystem {
                width: 90px;
                height: 70px;
                font-size: 12px;
                top: calc(50% - 35px);
            }
            .psii_complex { left: 3%; }
            .psi { left: 78%; }

            .controls {
                margin: 20px 0 10px;
                gap: 10px;
            }

            .btn {
                padding: 12px 25px;
                font-size: 14px;
                border-radius: 20px;
                min-width: 100px;
            }

            .step-info-container {
                padding: 15px;
                border-radius: 10px;
                margin: 15px auto; /* Keep centering */
                width: auto; /* Allow it to adjust */
            }
            .step-flow-chart {
                /* On small screens, it remains column, but now takes full width */
                width: 100%;
                gap: 10px;
            }
            .flow-step {
                width: 100%; /* Each step takes full width on smaller screens */
                max-width: none; /* Remove max-width constraint */
                margin-bottom: 5px;
                padding: 10px;
            }
            .flow-connector {
                font-size: 1.5em;
                margin: 5px 0;
            }
            .flow-step-title {
                font-size: 1em;
            }
            .flow-step-description {
                font-size: 0.85em;
            }

            .phase-indicator {
                top: 5px;
                right: 10px;
                padding: 8px 15px;
                font-size: 12px;
                border-radius: 15px;
                max-width: 60%;
                text-align: right;
            }
            .labels { /* Adjust for smaller screens */
                font-size: 0.9em; /* Smaller font for labels */
                padding: 6px 12px;
                top: 10px; /* Adjust top position for stroma */
                bottom: 10px; /* Adjust bottom position for lumen */
            }
            .stroma-label {
                left: 10px;
            }
            .lumen-label {
                right: 10px;
            }
            .membrane-bottom-label {
                right: 10px; /* Adjust right position for mobile */
                font-size: 0.9em;
                padding: 6px 12px;
            }

            /* Summary points responsive adjustments */
            .summary-container {
                padding: 15px;
            }
            .summary-container h2 {
                font-size: 1.5em;
            }
            .summary-section h3 {
                font-size: 1.2em;
            }
            .summary-section ul li {
                padding: 10px;
                font-size: 0.9em;
            }

            /* Quiz responsive adjustments */
            .quiz-container {
                padding: 15px;
            }
            .quiz-container h2 {
                font-size: 1.5em;
            }
            .question-item p.question-text {
                font-size: 1em;
            }
            .options label {
                font-size: 0.9em;
                padding: 6px 8px;
            }
            .quiz-controls .btn {
                padding: 10px 20px;
                font-size: 13px;
            }
        }

        /* Further adjustments for very small screens (e.g., iPhone SE) */
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }

            h1 {
                font-size: 1.4em;
            }

            .subtitle {
                font-size: 0.85em;
            }

            .diagram-container {
                height: 350px;
                max-height: 55vh;
            }

            .membrane {
                height: 60px;
            }

            .membrane-label {
                font-size: 12px;
            }
            
            .complex {
                width: 120px;
                height: 160px;
            }
            .complex-label {
                font-size: 10px;
                top: -15px;
            }
            .rieske, .cyt-bL, .cyt-bH, .cyt-f {
                font-size: 7px;
                width: 40px;
                height: 14px;
            }
            .rieske { top: 10px; left: 10px; }
            .cyt-bL { top: 35px; left: 75px; }
            .cyt-bH { top: 90px; left: 75px; }
            .cyt-f { top: 65px; left: 10px; }

            .binding-site {
                width: 22px;
                height: 22px;
                font-size: 7px;
            }
            .qo-site { bottom: 25px; }
            .qi-site { top: 25px; }

            .plastoquinone, .plastocyanin {
                width: 30px;
                height: 30px;
                font-size: 9px;
            }

            .electron, .proton {
                width: 14px;
                height: 14px;
                font-size: 7px;
            }

            .photosystem {
                width: 70px;
                height: 55px;
                font-size: 10px;
                top: calc(50% - 27px);
            }

            .btn {
                padding: 10px 20px;
                font-size: 13px;
                min-width: 90px;
            }

            .step-info-container {
                padding: 10px;
            }

            .flow-step {
                font-size: 0.8em;
                padding: 8px;
            }
            .flow-step-title {
                font-size: 0.9em;
            }
            .flow-step-description {
                font-size: 0.8em;
            }

            .labels {
                font-size: 9px;
            }
            .membrane-bottom-label {
                font-size: 0.8em;
                padding: 5px 10px;
            }

            /* Summary points responsive adjustments */
            .summary-container h2 {
                font-size: 1.3em;
            }
            .summary-section h3 {
                font-size: 1.1em;
            }
            .summary-section ul li {
                padding: 8px;
                font-size: 0.85em;
            }

            /* Quiz responsive adjustments */
            .quiz-container h2 {
                font-size: 1.3em;
            }
            .question-item p.question-text {
                font-size: 0.9em;
            }
            .options label {
                font-size: 0.85em;
            }
            .quiz-controls .btn {
                padding: 8px 15px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>The Q Cycle in Cytochrome b6f Complex</h1>
        <p class="subtitle">Interactive Animation of Electron Transport and Proton Pumping</p>
        
        <div class="intro-text">
            <p>The Q cycle in the cytochrome b‚ÇÜf complex is a sophisticated proton-motive mechanism that enhances the efficiency of photosynthetic electron transport in plants. Here's a detailed description of its mechanism and significance:</p>
            <h2>Role of the Cytochrome b‚ÇÜf Complex</h2>
            <ul>
                <li><strong>Location</strong>: Embedded in the thylakoid membrane of chloroplasts.</li>
                <li><strong>Function</strong>: Transfers electrons from Photosystem II (PSII) to Photosystem I (PSI) via plastoquinol (PQH‚ÇÇ) and plastocyanin (PC).</li>
                <li><strong>Key Outcome</strong>: Pumps protons (H‚Å∫) into the thylakoid lumen, contributing to the electrochemical gradient driving ATP synthesis.</li>
            </ul>
        </div>

        <div class="diagram-container" id="diagram">
            <div class="labels stroma-label">Stroma (High pH)</div>
            <div class="labels lumen-label">Thylakoid Lumen (Low pH)</div>
            <div class="phase-indicator" id="phaseIndicator">Initialization</div>
            
            <div class="membrane">
                <div class="membrane-label">Thylakoid Membrane</div>
            </div>
            <div class="membrane-bottom-label" id="membraneBottomLabel">Thylakoid Membrane</div>
            
            <div class="complex" id="cytb6f">
                <div class="complex-label">Cytochrome b6f</div>
                <div class="rieske">Rieske (FeS)</div>
                <div class="cyt-f">Cyt f</div>
                <div class="cyt-bL">Cyt bL</div>
                <div class="cyt-bH">Cyt bH</div>
                
                <div class="binding-site qi-site" id="qi-site" title="Qi Site (Stromal Side)">Qi</div>
                <div class="binding-site qo-site" id="qo-site" title="Qo Site (Lumenal Side)">Qo</div>
            </div>
            
            <div class="plastoquinone" id="pqh2-1" style="left: 100px; top: calc(50% - 20px);">PQH‚ÇÇ</div>
            <div class="plastoquinone" id="pq-pool" style="display: none; left: 100px; top: calc(50% + 20px); background: #95a5a6;" title="Plastoquinone Pool">PQ</div>
            <div class="plastoquinone" id="pqh2-2" style="display: none; left: 100px; top: calc(50% - 20px);">PQH‚ÇÇ</div>
            <div class="plastoquinone" id="semiquinone" style="display: none; left: 100px; top: calc(50% - 20px);">PQ‚Ä¢‚Åª</div>

            <div class="plastocyanin" id="pc">PC</div>
            <div class="plastocyanin" id="pc2">PC</div>
            <div class="photosystem" id="psii_complex" style="left: 5%; top: calc(50% - 40px);">Photosystem II</div>
            <div class="photosystem" id="psi" style="left: 75%; top: calc(50% - 40px);">Photosystem I</div>
            
            <div class="electron" id="e1" style="display: none;">e‚Åª</div>
            <div class="electron" id="e2" style="display: none;">e‚Åª</div>
            <div class="electron" id="e3" style="display: none;">e‚Åª</div>
            <div class="electron" id="e4" style="display: none;">e‚Åª</div>
            <div class="electron" id="e5" style="display: none;">e‚Åª</div>
            <div class="electron" id="e6" style="display: none;">e‚Åª</div>
            
            <div class="proton" id="h1" style="display: none;">H‚Å∫</div>
            <div class="proton" id="h2" style="display: none;">H‚Å∫</div>
            <div class="proton" id="h3" style="display: none;">H‚Å∫</div>
            <div class="proton" id="h4" style="display: none;">H‚Å∫</div>
        </div>

        <div class="controls">
            <button class="btn" onclick="nextStep()">Next Step</button>
            <button class="btn" onclick="resetAnimation()">Reset</button>
            <button class="btn" onclick="toggleAutoplay()">Auto Play</button>
        </div>

        <div class="step-info-container">
            <h3 class="step-title" style="text-align: center; margin-bottom: 20px;">Q Cycle Flow Chart</h3>
            <div class="step-flow-chart" id="flowChartContainer">
                <div id="initial-welcome-message" class="flow-step active-flow-step" style="opacity: 1; transform: scale(1);">
                    <div class="flow-step-title">Welcome to the Q Cycle Animation!</div>
                    <div class="flow-step-description">Click 'Next Step' to begin the animation. The Q cycle is a crucial process in the electron transport chain of photosynthesis, contributing to the proton gradient across the thylakoid membrane.</div>
                </div>
            </div>
        </div>

        <div class="summary-container" id="summaryPointsContainer">
            <h2>Summary of the Q Cycle</h2>
            <div class="summary-section">
                <h3>Proton & Electron Accounting</h3>
                <ul>
                    <li><strong>Per PQH‚ÇÇ oxidized at Qo:</strong>
                        <ul>
                            <li>2 H‚Å∫ released into the lumen.</li>
                            <li>1 electron sent to PSI (via PC).</li>
                            <li>1 electron sent to cytochrome b‚ÇÜ.</li>
                        </ul>
                    </li>
                    <li><strong>Per cycle (2 PQH‚ÇÇ oxidized):</strong>
                        <ul>
                            <li>4 H‚Å∫ pumped into the lumen.</li>
                            <li>2 electrons sent to PSI.</li>
                            <li>1 PQH‚ÇÇ regenerated at Q·µ¢ (using 2 H‚Å∫ from stroma).</li>
                        </ul>
                    </li>
                    <li><strong>Net Result:</strong> 4 H‚Å∫ translocated per 2 electrons (doubling H‚Å∫/e‚Åª ratio).</li>
                </ul>
            </div>
            <div class="summary-section">
                <h3>Key Features</h3>
                <ul>
                    <li><strong>Quinone Bifurcation:</strong> PQH‚ÇÇ oxidation splits electrons into high- and low-energy paths.</li>
                    <li><strong>Asymmetric Sites:</strong> Qo (lumen) and Qi (stroma) enable cross-membrane proton movement.</li>
                    <li><strong>Dimeric Structure:</strong> Two identical monomers share substrates, enhancing efficiency.</li>
                    <li><strong>Proton Gradient Amplification:</strong> Critical for ATP synthesis in photosynthesis.</li>
                </ul>
            </div>
            <div class="summary-section">
                <h3>Biological Significance</h3>
                <ul>
                    <li><strong>Energy Efficiency:</strong> Maximizes ATP yield per electron for carbon fixation (Calvin cycle).</li>
                    <li><strong>Regulation:</strong> Sensitive to pH, redox state, and inhibitors (e.g., antimycin A blocks Qi).</li>
                    <li><strong>Evolution:</strong> Conserved from cytochrome bc‚ÇÅ in mitochondria, optimized for photosynthesis.</li>
                </ul>
            </div>
        </div>

        <div class="quiz-container" id="quizContainer">
            <h2>Review Quiz</h2>
            <form id="quizForm">
            </form>
            <div class="quiz-controls">
                <button type="button" class="btn" onclick="submitQuiz()">Submit Answers</button>
                <button type="button" class="btn" onclick="resetQuiz()">Reset Quiz</button>
            </div>
        </div>

        <div style="text-align: center; margin-top: 50px; color: #555;">
            <div id="security-email-display">
                betabiosciences@gmail.com
            </div>
            <div style="margin-top: 10px;">
                <a href="https://t.me/betascience_csir" target="_blank" style="color: #007bff; text-decoration: none;">Join our Telegram Channel</a>
            </div>
        </div>
        <!-- This hidden div contains a security string to verify the script's origin -->
        <div id="security-check-value" style="display: none;">betabiosciences@gmail.com</div>
    </div>

    <script>
        // Security check - START: This must be at the very top of the script
        const allowedDomain = "betabiosciences.github.io"; // The allowed hostname
        const currentHostname = window.location.hostname;

        if (currentHostname !== allowedDomain) {
            // If the current hostname does not match the allowed domain,
            // prevent the script from executing.
            // This is done by overriding window.onload and throwing an error,
            // which stops further script parsing/execution without showing an error to the user.
            window.onload = function() {}; // Override onload to do nothing
            throw new Error("Unauthorized domain. Script execution halted."); // This will stop script execution here
        }
        // Security check - END

        let currentStep = 0;
        let isPlaying = false;
        let autoplayInterval;
        const animationSpeed = 3500; // General animation speed in milliseconds (increased for slower animation)
        const subAnimationSpeed = animationSpeed / 3; // For sequential steps within a phase


        // Get elements once to avoid repeated DOM queries
        const pqh2_1 = document.getElementById('pqh2-1');
        const pq_pool = document.getElementById('pq-pool');
        const pc = document.getElementById('pc');
        const pc2 = document.getElementById('pc2'); // Get the new PC element
        const electron1 = document.getElementById('e1');
        const electron2 = document.getElementById('e2');
        const electron3 = document.getElementById('e3');
        const electron4 = document.getElementById('e4');
        const electron5 = document.getElementById('e5');
        const electron6 = document.getElementById('e6');
        const proton1 = document.getElementById('h1');
        const proton2 = document.getElementById('h2');
        const proton3 = document.getElementById('h3');
        const proton4 = document.getElementById('h4');
        const phaseIndicator = document.getElementById('phaseIndicator');
        const flowChartContainer = document.getElementById('flowChartContainer'); // Changed from stepInfoDiv
        const qoSite = document.getElementById('qo-site');
        const qiSite = document.getElementById('qi-site');
        const cytb6f = document.getElementById('cytb6f');
        const psi = document.getElementById('psi'); 
        const psii_complex = document.getElementById('psii_complex'); 
        const summaryPointsContainer = document.getElementById('summaryPointsContainer');
        const quizContainer = document.getElementById('quizContainer');
        const quizForm = document.getElementById('quizForm');


        let pqh2_2 = document.getElementById('pqh2-2');
        let semiquinone = document.getElementById('semiquinone');

        // Define quiz questions and answers
        const quizQuestions = [
            {
                question: "1. The Q cycle in the cytochrome b‚ÇÜf complex primarily serves to:",
                options: [
                    "A) Transfer electrons directly from PSII to PSI.",
                    "B) Increase the proton gradient across the thylakoid membrane.",
                    "C) Synthesize ATP directly.",
                    "D) Reduce NADP‚Å∫ to NADPH."
                ],
                answer: "B) Increase the proton gradient across the thylakoid membrane."
            },
            {
                question: "2. How many protons are pumped into the thylakoid lumen per full Q cycle (oxidation of 2 PQH‚ÇÇ molecules)?",
                options: [
                    "A) 2",
                    "B) 4",
                    "C) 6",
                    "D) 8"
                ],
                answer: "B) 4"
            },
            {
                question: "3. The Qo site in the cytochrome b‚ÇÜf complex is located:",
                options: [
                    "A) On the stromal side.",
                    "B) On the lumenal side.",
                    "C) In the thylakoid matrix.",
                    "D) Bound to PSI."
                ],
                answer: "B) On the lumenal side."
            },
            {
                question: "4. What happens to the second electron from PQH‚ÇÇ oxidation at the Qo site?",
                options: [
                    "A) It is transferred directly to PSI.",
                    "B) It reduces cytochrome b‚ÇÜ (heme b‚Çõ ‚Üí heme b‚Çï).",
                    "C) It is lost as heat.",
                    "D) It reduces ferredoxin."
                ],
                answer: "B) It reduces cytochrome b‚ÇÜ (heme b‚Çõ ‚Üí heme b‚Çï)."
            },
            {
                question: "5. The Qi site of the cytochrome b‚ÇÜf complex is responsible for:",
                options: [
                    "A) Oxidizing PQH‚ÇÇ and releasing protons into the lumen.",
                    "B) Reducing plastoquinone (PQ) to PQH‚ÇÇ using stromal protons.",
                    "C) Transferring electrons to plastocyanin.",
                    "D) Binding to the oxygen-evolving complex."
                ],
                answer: "B) Reducing plastoquinone (PQ) to PQH‚ÇÇ using stromal protons."
            },
            {
                question: "6. What is the net reaction of the Q cycle after oxidation of two PQH‚ÇÇ molecules?",
                options: [
                    "A) 2 PQH‚ÇÇ ‚Üí 2 PQ + 4 H‚Å∫ (lumen) + 2 e‚Åª (to PSI)",
                    "C) 2 PQH‚ÇÇ ‚Üí 1 PQ + 1 PQH‚ÇÇ + 4 H‚Å∫ (lumen) + 2 e‚Åª (to PSI)",
                    "D) 2 PQH‚ÇÇ ‚Üí 2 PQ + 2 H‚Å∫ (lumen) + 4 e‚Åª (to PSI)"
                ],
                answer: "C) 2 PQH‚ÇÇ ‚Üí 1 PQ + 1 PQH‚ÇÇ + 4 H‚Å∫ (lumen) + 2 e‚Åª (to PSI)"
            },
            {
                question: "7. Which of the following best describes the electron bifurcation in the Q cycle?",
                options: [
                    "A) Both electrons from plastoquinol follow the same path",
                    "B) One electron is transferred to a high-potential chain, and the other to a low-potential chain",
                    "C) Electrons are transferred directly to ATP synthase",
                    "D) Electrons are cycled back to photosystem II"
                ],
                answer: "B) One electron is transferred to a high-potential chain, and the other to a low-potential chain"
            },
            {
                question: "8. What is the net outcome of two complete Q cycles in the cytochrome b6f complex?",
                options: [
                    "A) Oxidation of one plastoquinol and reduction of two plastoquinones",
                    "B) Oxidation of two plastoquinols and reduction of one plastoquinone",
                    "C) Transfer of four electrons to photosystem I",
                    "D) Translocation of two protons across the membrane"
                ],
                answer: "B) Oxidation of two plastoquinols and reduction of one plastoquinone"
            },
            {
                question: "9. How does the Q cycle contribute to the proton motive force in chloroplasts?",
                options: [
                    "A) By reducing plastoquinone at the Qo site",
                    "B) By translocating protons from the stroma to the thylakoid lumen",
                    "C) By transferring electrons directly to NADP+",
                    "D) By synthesizing ATP in the cytochrome b6f complex"
                ],
                answer: "B) By translocating protons from the stroma to the thylakoid lumen"
            },
            {
                question: "10. In the absence of the Q cycle, what would be the primary consequence for photosynthesis?",
                options: [
                    "A) Complete cessation of electron transport",
                    "B) Reduced proton gradient across the thylakoid membrane",
                    "C) Increased NADPH production",
                    "D) Direct reduction of ferredoxin"
                ],
                answer: "B) Reduced proton gradient across the thylakoid membrane"
            }
        ];


        function updatePositions() {
            complexRect = cytb6f.getBoundingClientRect(); 
            diagramRect = document.getElementById('diagram').getBoundingClientRect();
            membraneRect = document.querySelector('.membrane').getBoundingClientRect();

            complexLeft = complexRect.left - diagramRect.left; 
            complexTop = complexRect.top - diagramRect.top;   
            complexWidth = complexRect.width;
            complexHeight = complexRect.height;

            qiX = complexLeft + complexWidth / 2 - qiSite.offsetWidth / 2;
            qiY = complexTop + qiSite.offsetTop; 

            qoX = complexLeft + complexWidth / 2 - qoSite.offsetWidth / 2;
            qoY = complexTop + qoSite.offsetTop; 

            rieskeX = complexLeft + 20 + 30; 
            rieskeY = complexTop + 20 + 10;
            cytfX = complexLeft + 20 + 30;
            cytfY = complexTop + 90 + 10;
            cytbLX = complexLeft + 120 + 30;
            cytbLY = complexTop + 50 + 10;
            cytbHX = complexLeft + 120 + 30;
            cytbHY = complexTop + 120 + 10;

            membraneThickness = membraneRect.height; /* Dynamically get from CSS */
            membraneHalfThickness = membraneThickness / 2;
            membraneCenterY = membraneRect.top - diagramRect.top + membraneHalfThickness;

            stromaY = membraneCenterY - membraneHalfThickness - 70; // Position above membrane
            // Updated lumenY to make protons diffuse closer to the bottom label
            lumenY = diagramRect.height - 44; // Target top position for protons to be near the bottom label
            // The value 44 is calculated to place the center of the 18px proton approx 35px from the bottom edge of the 600px tall diagram-container.
            // 600 (diagram height) - 35 (desired offset from bottom for proton center) - 9 (half proton height) = 516. 
            // So, `lumenY` of 516px means the top of the proton is at 516px.
            
            // Adjust lumenY for mobile if diagram height changes significantly
            // On smaller screens, lumenY should be relative to the new diagram height
            if (window.innerWidth <= 768) { /* Or use a more precise breakpoint */
                lumenY = diagramRect.height - 30; /* Adjust to be closer to bottom edge but not off-screen */
            }


            plastoquinoneHeight = pqh2_1.offsetHeight; // Get actual height
            photosystemHeight = psii_complex.offsetHeight;
        }

        const steps = [
            {
                title: "Step 1: PQH‚ÇÇ Diffuses and Binds to Qo Site",
                description: "A plastoquinol (PQH‚ÇÇ) molecule diffuses within the thylakoid membrane and binds to the Qo site (Quinone-outside) on the lumenal side of the Cytochrome b6f complex.",
                action: () => {
                    resetElements(); // Ensure a clean state before step 1
                    pqh2_1.style.display = 'flex';
                    // Initial position slightly left within the membrane
                    pqh2_1.style.left = `100px`; 
                    pqh2_1.style.top = `${membraneCenterY - plastoquinoneHeight / 2}px`; 

                    setTimeout(() => {
                        pqh2_1.style.left = `${qoX}px`;
                        pqh2_1.style.top = `${qoY - (pqh2_1.offsetHeight / 2) + (qoSite.offsetHeight / 2) + 5}px`; // Move to Qo site
                        pqh2_1.classList.add('active');
                    }, 100);
                    updatePhaseIndicator('Phase 1: PQH‚ÇÇ ‚Üí Qo (Lumenal)');
                }
            },
            {
                title: "Step 2: Oxidation of PQH‚ÇÇ & Proton Release; Oxidized PQ Returns to PSII",
                description: "PQH‚ÇÇ is oxidized to PQ at the Qo site, releasing two protons (H‚Å∫) into the thylakoid lumen. The oxidized PQ then returns to Photosystem II (PSII).",
                action: () => {
                    pqh2_1.classList.remove('active');
                    pqh2_1.innerHTML = 'PQ';
                    pqh2_1.style.background = '#95a5a6'; // Change color to oxidized

                    proton1.style.display = 'flex';
                    proton2.style.display = 'flex';

                    // Position them initially at the bottom edge of Qo site, slightly apart
                    // This is their *starting* point for diffusion
                    proton1.style.left = `${qoX + (qoSite.offsetWidth / 2) - proton1.offsetWidth - 10}px`; // To the left of Qo center
                    proton1.style.top = `${qoY + qoSite.offsetHeight}px`; // At the bottom edge of Qo

                    proton2.style.left = `${qoX + (qoSite.offsetWidth / 2) + 10}px`; // To the right of Qo center
                    proton2.style.top = `${qoY + qoSite.offsetHeight}px`; // At the bottom edge of Qo

                    // Animate them diffusing into the lumen
                    setTimeout(() => {
                        proton1.style.left = `${qoX - 60}px`; // Further left
                        proton1.style.top = `${lumenY}px`; // Down into the lumen

                        proton2.style.left = `${qoX + 60}px`; // Further right
                        proton2.style.top = `${lumenY}px`; // Down into the lumen
                    }, 50); // Small delay to ensure initial render before transition starts

                    // Protons disappear after completing diffusion animation
                    setTimeout(() => {
                        proton1.style.display = 'none';
                        proton2.style.display = 'none';
                        // Reset positions to ensure they reappear correctly next time
                        // Need to reset the positions that are set dynamically so they don't jump on next appearance
                        proton1.style.left = `${qoX + (qoSite.offsetWidth / 2) - proton1.offsetWidth - 10}px`;
                        proton1.style.top = `${qoY + qoSite.offsetHeight}px`;
                        proton2.style.left = `${qoX + (qoSite.offsetWidth / 2) + 10}px`;
                        proton2.style.top = `${qoY + qoSite.offsetHeight}px`;
                    }, animationSpeed + 500); // 500ms after animation is visually done


                    // Oxidized PQ returns to PSII
                    setTimeout(() => {
                        pqh2_1.style.left = `${psii_complex.offsetLeft + psii_complex.offsetWidth / 2 - pqh2_1.offsetWidth / 2}px`;
                        pqh2_1.style.top = `${membraneCenterY - pqh2_1.offsetHeight / 2}px`; // Returns inside membrane near PSII
                        pqh2_1.style.opacity = '0'; // Fade out as it reaches PSII
                    }, animationSpeed); // After protons are released and have time to move

                    updatePhaseIndicator('Phase 2: PQH‚ÇÇ Oxidation, 2H‚Å∫ to Lumen, PQ ‚Üí PSII');
                }
            },
            {
                title: "Step 3: Electron 1 to Rieske Centre",
                description: "One electron from the oxidized PQH‚ÇÇ is transferred to the Rieske Iron-Sulfur (FeS) center within the cytochrome b6f complex.",
                action: () => {
                    electron1.style.display = 'flex';
                    electron1.style.left = `${qoX + 15}px`; 
                    electron1.style.top = `${qoY + 15}px`; 
                    
                    setTimeout(() => {
                        electron1.style.left = `${rieskeX}px`;
                        electron1.style.top = `${rieskeY}px`;
                    }, animationSpeed / 5);
                    updatePhaseIndicator('Phase 3: 1e‚Åª ‚Üí Rieske');
                }
            },
            {
                title: "Step 4: Second Electron to Cytochrome bL",
                description: "The second electron from PQH‚ÇÇ is transferred to cytochrome bL (Cyt bL) within the complex.",
                action: () => {
                    electron2.style.display = 'flex';
                    electron2.style.left = `${qoX + 10}px`; 
                    electron2.style.top = `${qoY + 20}px`;

                    setTimeout(() => {
                        electron2.style.left = `${cytbLX}px`;
                        electron2.style.top = `${cytbLY}px`;
                    }, animationSpeed / 5);
                    updatePhaseIndicator('Phase 4: second e‚Åª ‚Üí Cyt bL');
                }
            },
            {
                title: "Step 5: Electron from Rieske to Cytochrome f",
                description: "The electron from the Rieske center moves to Cytochrome f (Cyt f).",
                action: () => {
                    electron1.style.left = `${cytfX}px`;
                    electron1.style.top = `${cytfY}px`;
                    updatePhaseIndicator('Phase 5: e‚Åª (Rieske) ‚Üí Cyt f');
                }
            },
            {
                title: "Step 6: Electron from Cytochrome f to Plastocyanin",
                description: "The electron from Cytochrome f is then transferred to Plastocyanin (PC), which is a mobile electron carrier in the lumen. The electron remains bound to PC.",
                action: () => {
                    // Temporarily set electron's z-index lower to appear "within" PC
                    electron1.style.zIndex = '4'; 
                    // Move electron to be centered within PC
                    electron1.style.left = `${pc.offsetLeft + (pc.offsetWidth / 2) - (electron1.offsetWidth / 2)}px`;
                    electron1.style.top = `${pc.offsetTop + (pc.offsetHeight / 2) - (electron1.offsetHeight / 2)}px`;
                    
                    pc.style.background = '#27ae60'; // PC becomes reduced (green)
                    pc.innerHTML = 'PC‚Åª';
                    // Electron does NOT disappear here, it stays with PC
                    updatePhaseIndicator('Phase 6: e‚Åª (Cyt f) ‚Üí PC');
                }
            },
            {
                title: "Step 7: Plastocyanin (with electron) Diffuses to Photosystem I",
                description: "The reduced Plastocyanin (PC‚Åª), still carrying its electron, diffuses through the thylakoid lumen to deliver its electron to Photosystem I (PSI).",
                action: () => {
                    // Set electron's z-index back to high for movement visibility
                    electron1.style.zIndex = '10'; 

                    // Get target coordinates for PSI for both PC and electron
                    const targetLeft = psi.offsetLeft + psi.offsetWidth / 2 - pc.offsetWidth / 2;
                    const targetTop = psi.offsetTop + psi.offsetHeight / 2 - pc.offsetHeight / 2 + 50; // Move to PSI area

                    // PC moves towards PSI
                    pc.style.left = `${targetLeft}px`; 
                    pc.style.top = `${targetTop}px`; 
                    pc.style.opacity = '0'; // Fade out PC as it delivers electron

                    // Electron also moves with PC and fades out
                    electron1.style.left = `${targetLeft + (pc.offsetWidth / 2) - (electron1.offsetWidth / 2)}px`; // Adjust electron's position to stay centered in PC's new spot
                    electron1.style.top = `${targetTop + (pc.offsetHeight / 2) - (electron1.offsetHeight / 2)}px`;
                    electron1.style.opacity = '0'; // Fade out electron with PC

                    setTimeout(() => {
                        electron1.style.display = 'none'; // Finally hide electron after fade
                    }, animationSpeed); // Matches PC fade-out-duration
                    
                    updatePhaseIndicator('Phase 7: PC (with e‚Åª) ‚Üí PSI');
                }
            },
            {
                title: "Step 8: Electron from Cytochrome bL to Cytochrome bH",
                description: "The electron from Cytochrome bL is transferred to Cytochrome bH (Cyt bH).",
                action: () => {
                    electron2.style.left = `${cytbHX}px`;
                    electron2.style.top = `${cytbHY}px`;
                    updatePhaseIndicator('Phase 8: e‚Åª (Cyt bL) ‚Üí Cyt bH');
                }
            },
            {
                title: "Step 9: Electron from Cytochrome bH to Qi Site",
                description: "The electron from Cytochrome bH moves to the Qi site (Quinone-inside) of the complex.",
                action: () => {
                    electron2.style.left = `${qiX + 15}px`;
                    electron2.style.top = `${qiY + 15}px`;
                    updatePhaseIndicator('Phase 9: e‚Åª (Cyt bH) ‚Üí Qi (Stromal)');
                }
            },
            {
                title: "Step 10: Semiquinone (PQ‚Ä¢‚Åª) Forms at Qi Site",
                description: "The electron at the Qi site reduces a molecule of oxidized plastoquinone (PQ) from the membrane pool to form a semiquinone radical (PQ‚Ä¢‚Åª). This requires one electron and one proton from the stroma. The PQ pool becomes temporarily hidden as one PQ molecule is used.",
                action: () => {
                    electron2.style.display = 'none'; // Electron absorbed by PQ
                    pq_pool.style.display = 'none'; // PQ from pool is now at Qi
                    semiquinone.style.display = 'flex';
                    semiquinone.style.left = `${qiX}px`;
                    semiquinone.style.top = `${qiY}px`;
                    semiquinone.classList.add('active');
                    semiquinone.innerHTML = 'PQ‚Ä¢‚Åª';
                    semiquinone.style.background = '#e67e22'; // Orange for semiquinone

                    // Proton from stroma - start from stroma, then move
                    proton3.style.display = 'flex';
                    // Start proton from a bit above Qi. Start position is now `stromaY`
                    proton3.style.left = `${qiX + (qiSite.offsetWidth / 2) - (proton3.offsetWidth / 2) - 5}px`; 
                    proton3.style.top = `${stromaY}px`; 
                    setTimeout(() => { // Animate moving towards Qi site
                         proton3.style.left = `${qiX - 20}px`;
                         proton3.style.top = `${qiY}px`; // Move closer to Qi Y
                    }, animationSpeed / 5);

                    setTimeout(() => { proton3.style.display = 'none'; }, animationSpeed); // Proton absorbed
                    
                    updatePhaseIndicator('Phase 10: PQ ‚Üí PQ‚Ä¢‚Åª (Qi)');
                }
            },
            {
                title: "Step 11: Second PQH‚ÇÇ Diffuses and Binds to Qo Site",
                description: "A second PQH‚ÇÇ molecule diffuses within the thylakoid membrane and binds to the Qo site (lumenal side), initiating the second half of the Q cycle.",
                action: () => {
                    // Make sure pqh2_1 (the oxidized PQ) is completely gone or hidden
                    pqh2_1.style.display = 'none';
                    pqh2_1.style.opacity = '1'; // Reset opacity for next cycle if needed

                    pqh2_2.style.display = 'flex';
                    pqh2_2.innerHTML = 'PQH‚ÇÇ';
                    pqh2_2.style.background = '#f39c12';
                    pqh2_2.style.left = `100px`; // Initial position for second PQH2 within membrane
                    pqh2_2.style.top = `${membraneCenterY - plastoquinoneHeight / 2}px`; 
                    
                    setTimeout(() => {
                        pqh2_2.style.left = `${qoX}px`;
                        pqh2_2.style.top = `${qoY - (pqh2_2.offsetHeight / 2) + (qoSite.offsetHeight / 2) + 5}px`; // Move to Qo
                        pqh2_2.classList.add('active');
                    }, animationSpeed / 2);

                    updatePhaseIndicator('Phase 11: Second PQH‚ÇÇ ‚Üí Qo (Lumenal)');
                }
            },
            {
                title: "Step 12: Second PQH‚ÇÇ Oxidation and PC Delivery to Photosystem I",
                description: "The second PQH‚ÇÇ molecule undergoes oxidation at the Qo site, releasing two more protons into the lumen. Electron flow: 1e‚Åª ‚Üí Rieske center ‚Üí Cytochrome f ‚Üí PC ‚Üí PSI.",
                action: () => {
                    // Oxidation of PQH2_2 and release of protons (exact same logic as Phase 2)
                    pqh2_2.classList.remove('active');
                    pqh2_2.innerHTML = 'PQ';
                    pqh2_2.style.background = '#95a5a6'; // New PQH2 becomes oxidized PQ
                    // Send this PQ back to PSII after oxidation, similar to step 2
                    setTimeout(() => {
                        pqh2_2.style.left = `${psii_complex.offsetLeft + psii_complex.offsetWidth / 2 - pqh2_2.offsetWidth / 2}px`;
                        pqh2_2.style.top = `${membraneCenterY - pqh2_2.offsetHeight / 2}px`; // Returns inside membrane near PSII
                        pqh2_2.style.opacity = '0';
                    }, animationSpeed);

                    proton1.style.display = 'flex';
                    proton2.style.display = 'flex';

                    // Position them initially at the bottom edge of Qo site, slightly apart
                    // This is their *starting* point for diffusion
                    proton1.style.left = `${qoX + (qoSite.offsetWidth / 2) - proton1.offsetWidth - 10}px`;
                    proton1.style.top = `${qoY + qoSite.offsetHeight}px`;

                    proton2.style.left = `${qoX + (qoSite.offsetWidth / 2) + 10}px`;
                    proton2.style.top = `${qoY + qoSite.offsetHeight}px`;

                    // Animate them diffusing into the lumen
                    setTimeout(() => {
                        proton1.style.left = `${qoX - 60}px`;
                        proton1.style.top = `${lumenY}px`;

                        proton2.style.left = `${qoX + 60}px`;
                        proton2.style.top = `${lumenY}px`;
                    }, 50);

                    // Protons disappear after completing diffusion animation
                    setTimeout(() => {
                        proton1.style.display = 'none';
                        proton2.style.display = 'none';
                        // Reset positions
                        proton1.style.left = `${qoX + (qoSite.offsetWidth / 2) - proton1.offsetWidth - 10}px`;
                        proton1.style.top = `${qoY + qoSite.offsetHeight}px`;
                        proton2.style.left = `${qoX + (qoSite.offsetWidth / 2) + 10}px`;
                        proton2.style.top = `${qoY + qoSite.offsetHeight}px`;
                    }, animationSpeed + 500);

                    // Electron 1 movement: Qo -> Rieske (pause) -> Cyt f (pause) -> PC2 (pause/reduction) -> PSI
                    electron3.style.display = 'flex';
                    electron3.style.left = `${qoX + 15}px`;
                    electron3.style.top = `${qoY + 15}px`;

                    setTimeout(() => { // Move to Rieske
                        electron3.style.left = `${rieskeX}px`;
                        electron3.style.top = `${rieskeY}px`;
                        setTimeout(() => { // Pause at Rieske
                            setTimeout(() => { // Move to Cyt f
                                electron3.style.left = `${cytfX}px`;
                                electron3.style.top = `${cytfY}px`;
                                setTimeout(() => { // Pause at Cyt f
                                    // Ensure pc2 is visible and in its initial position
                                    pc2.style.display = 'flex';
                                    pc2.style.opacity = '1';

                                    // Move electron3 to PC2's position
                                    electron3.style.left = `${pc2.offsetLeft + (pc2.offsetWidth / 2) - (electron3.offsetWidth / 2)}px`;
                                    electron3.style.top = `${pc2.offsetTop + (pc2.offsetHeight / 2) - (electron3.offsetHeight / 2)}px`;
                                    setTimeout(() => { // Electron reaches PC2, then disappears and PC2 changes
                                        electron3.style.display = 'none'; // Electron absorbed by PC2
                                        pc2.style.background = '#27ae60'; // PC2 becomes reduced
                                        pc2.innerHTML = 'PC‚ÇÇ‚Åª'; // Label as PC2- to distinguish
                                        setTimeout(() => { // Pause at PC2 after reduction
                                            setTimeout(() => { // PC2 moves to PSI
                                                const targetLeft = psi.offsetLeft + psi.offsetWidth / 2 - pc2.offsetWidth / 2;
                                                const targetTop = psi.offsetTop + psi.offsetHeight / 2 - pc2.offsetHeight / 2 + 50; 

                                                pc2.style.left = `${targetLeft}px`; 
                                                pc2.style.top = `${targetTop}px`; 
                                                pc2.style.opacity = '0'; 

                                                setTimeout(() => {
                                                    pc2.style.display = 'none'; 
                                                }, subAnimationSpeed); 
                                            }, subAnimationSpeed); // Start PC2 movement after pause at PC2
                                        }, subAnimationSpeed); // Pause at PC2 after reduction
                                    }, subAnimationSpeed); // Electron moves to PC2
                                }, subAnimationSpeed); // Pause at Cyt f
                            }, subAnimationSpeed); // Electron reaches Cyt f
                        }, subAnimationSpeed); // Pause at Rieske
                    }, subAnimationSpeed); // Initial electron movement from Qo

                    // Update the phase indicator with the desired text
                    updatePhaseIndicator('Phase 12: 2nd PQH‚ÇÇ oxidation, 2H‚Å∫ to Lumen. 1e‚Åª ‚Üí Rieske center ‚Üí Cyt f ‚Üí PC ‚Üí PSI.');
                }
            },
            {
                title: "Step 13: Electron 2 (from 2nd PQH‚ÇÇ) to Qi Site",
                description: "The second electron from the newly bound PQH‚ÇÇ moves to Cytochrome bL, then to Cytochrome bH, and finally to the Qi site (stromal side).",
                action: () => {
                    electron4.style.display = 'flex';
                    electron4.style.left = `${qoX + 10}px`;
                    electron4.style.top = `${qoY + 20}px`;

                    setTimeout(() => { // Move to Cyt bL
                        electron4.style.left = `${cytbLX}px`;
                        electron4.style.top = `${cytbLY}px`;
                        setTimeout(() => { // Pause at Cyt bL
                            setTimeout(() => { // Move to Cyt bH
                                electron4.style.left = `${cytbHX}px`;
                                electron4.style.top = `${cytbHY}px`;
                                setTimeout(() => { // Pause at Cyt bH
                                    setTimeout(() => { // Move to Qi site
                                        electron4.style.left = `${qiX + 15}px`;
                                        electron4.style.top = `${qiY + 15}px`;
                                    }, subAnimationSpeed); // Move to Qi
                                }, subAnimationSpeed); // Pause at Cyt bH
                            }, subAnimationSpeed); // Move to Cyt bH
                        }, subAnimationSpeed); // Pause at Cyt bL
                    }, subAnimationSpeed); // Initial move to Cyt bL
                    updatePhaseIndicator('Phase 13: second e‚Åª (2nd PQH‚ÇÇ) ‚Üí Cyt bL ‚Üí Cyt bH ‚Üí Qi (Stromal)');
                }
            },
            {
                title: "Step 14: PQ‚Ä¢‚Åª at Qi Reduced to PQH‚ÇÇ (2H‚Å∫ from Stroma)",
                description: "The second electron arriving at the Qi site, along with another electron from the first PQH‚ÇÇ oxidation (which formed the semiquinone), and two protons from the stroma, fully reduces the semiquinone (PQ‚Ä¢‚Åª) to PQH‚ÇÇ.",
                action: () => {
                    electron4.style.display = 'none'; // Electron absorbed

                    semiquinone.classList.remove('active');
                    semiquinone.innerHTML = 'PQH‚ÇÇ';
                    semiquinone.style.background = '#f39c12'; // PQH2 color

                    // Two protons from stroma to Qi site (top of complex)
                    proton3.style.display = 'flex';
                    proton4.style.display = 'flex';
                    
                    // Initial position for protons from the stroma (above Qi site, slightly spread out)
                    proton3.style.left = `${qiX + (qiSite.offsetWidth / 2) - proton3.offsetWidth - 10}px`;
                    proton3.style.top = `${stromaY}px`; 
                    proton4.style.left = `${qiX + (qiSite.offsetWidth / 2) + 10}px`;
                    proton4.style.top = `${stromaY}px`; 

                    // Animate them moving towards the Qi site
                    setTimeout(() => {
                         proton3.style.left = `${qiX - 20}px`;
                         proton3.style.top = `${qiY + qiSite.offsetHeight / 2 - proton3.offsetHeight / 2}px`; // Move to Qi Y-center
                         proton4.style.left = `${qiX + 20}px`;
                         proton4.style.top = `${qiY + qiSite.offsetHeight / 2 - proton4.offsetHeight / 2}px`; // Move to Qi Y-center
                    }, 50);

                    // Protons disappear after reaching Qi site
                    setTimeout(() => { 
                        proton3.style.display = 'none'; 
                        proton4.style.display = 'none'; 
                        // Reset positions for next cycle
                        proton3.style.left = `${qiX + (qiSite.offsetWidth / 2) - proton3.offsetWidth - 10}px`;
                        proton3.style.top = `${stromaY}px`; 
                        proton4.style.left = `${qiX + (qiSite.offsetWidth / 2) + 10}px`;
                        proton4.style.top = `${stromaY}px`;
                    }, animationSpeed + 500); // 500ms after animation is visually done

                    updatePhaseIndicator('Phase 14: PQ‚Ä¢‚Åª + 2e‚Åª + 2H‚Å∫ ‚Üí PQH‚ÇÇ (Qi)');
                }
            },
            {
                title: "Step 15: PQH‚ÇÇ Released from Qi Site",
                description: "The newly regenerated PQH‚ÇÇ molecule is released from the Qi site (stromal side) back into the thylakoid membrane pool.",
                action: () => {
                    semiquinone.style.opacity = '1'; // Ensure visibility
                    semiquinone.innerHTML = 'PQH‚ÇÇ';
                    semiquinone.style.background = '#f39c12';

                    // Start from Qi site
                    semiquinone.style.left = `${qiX}px`; 
                    semiquinone.style.top = `${qiY}px`; 

                    // Animate it diffusing sideways into the membrane, e.g., to the left
                    setTimeout(() => {
                        // Move sideways out of the complex and into the membrane region
                        semiquinone.style.left = `${complexLeft - semiquinone.offsetWidth - 50}px`; // Move further left from complex
                        semiquinone.style.top = `${membraneCenterY - semiquinone.offsetHeight / 2}px`; // Keep it vertically centered in membrane
                    }, 50);

                    // After diffusing into the membrane, it blends into the pool
                    setTimeout(() => {
                        semiquinone.style.display = 'none'; // Hide the specific semiquinone element
                        pq_pool.style.display = 'flex'; // Make sure the general PQ pool is visible
                        // Reset semiquinone position for next cycle
                        semiquinone.style.left = `${qiX}px`;
                        semiquinone.style.top = `${qiY}px`;
                    }, animationSpeed + 500); // Time for the diffusion transition + buffer
                    
                    // Ensure pqh2_1 and pqh2_2 are hidden as they've returned to PSII and are conceptually gone
                    pqh2_1.style.display = 'none';
                    pqh2_2.style.display = 'none';

                    updatePhaseIndicator('Phase 15: PQH‚ÇÇ Released from Qi');
                }
            },
            {
                title: "Step 16: One Q Cycle Completed",
                description: "At the completion of one Q cycle, two PQH‚ÇÇ molecules are oxidized at the Qo site (lumenal side), resulting in the release of four protons into the lumen and the transfer of two electrons to Plastocyanin. One PQ is regenerated at the Qi site (stromal side), utilizing two electrons from the Qo site and two protons from the stroma. This process efficiently moves protons across the membrane, building the proton-motive force.",
                action: () => {
                    updatePhaseIndicator('Q Cycle Completed!');
                    phaseIndicator.style.background = '#27ae60'; // Green for completion
                    summaryPointsContainer.style.display = 'block'; // Show summary points
                    quizContainer.style.display = 'block'; // Show quiz container
                }
            }
        ];

        // Function to render the flow chart steps dynamically
        function renderFlowChart(stepIndexToRender) {
            // Clear all current steps if it's the beginning of the animation or a reset
            if (stepIndexToRender === 0) {
                flowChartContainer.innerHTML = '';
                // Add the initial welcome message back
                const initialWelcomeDiv = document.createElement('div');
                initialWelcomeDiv.id = 'initial-welcome-message';
                initialWelcomeDiv.classList.add('flow-step', 'active-flow-step');
                initialWelcomeDiv.style.opacity = '1';
                initialWelcomeDiv.style.transform = 'scale(1)';
                initialWelcomeDiv.innerHTML = `
                    <div class="flow-step-title">Welcome to the Q Cycle Animation!</div>
                    <div class="flow-step-description">Click 'Next Step' to begin the animation. The Q cycle is a crucial process in the electron transport chain of photosynthesis, contributing to the proton gradient across the thylakoid membrane.</div>
                `;
                flowChartContainer.appendChild(initialWelcomeDiv);
            }

            // If it's a step beyond the initial welcome, add the actual step and connector
            if (stepIndexToRender < steps.length) {
                // If not the very first step, add a connector
                if (stepIndexToRender > 0) {
                    const connectorDiv = document.createElement('div');
                    connectorDiv.classList.add('flow-connector');
                    connectorDiv.innerHTML = '&#8595;'; // Down arrow character
                    flowChartContainer.appendChild(connectorDiv);
                }

                // Add the new step element
                const step = steps[stepIndexToRender];
                const flowStepDiv = document.createElement('div');
                flowStepDiv.id = `flow-step-${stepIndexToRender}`;
                flowStepDiv.classList.add('flow-step');
                flowStepDiv.innerHTML = `
                    <div class="flow-step-title">${step.title}</div>
                    <div class="flow-step-description">${step.description}</div>
                `;
                flowChartContainer.appendChild(flowStepDiv);
            }
        }

        // Modified updateStepInfo to highlight and manage flow chart steps visibility
        function updateStepInfo(stepIndex) {
            // Remove active/completed classes from all steps for fresh highlighting
            // This is crucial for the "one below the other" effect to work as new steps are added
            document.querySelectorAll('.flow-step').forEach(step => {
                step.classList.remove('active-flow-step'); // Only remove active, completed stays
            });

            // If it's the animation completion (after last step's action)
            if (stepIndex === steps.length) {
                // Mark all steps as completed when the animation finishes
                document.querySelectorAll('.flow-step').forEach(step => {
                    step.classList.add('completed-flow-step');
                    step.classList.remove('active-flow-step');
                    step.style.opacity = '1'; /* Ensure all completed steps are fully visible */
                    step.style.transform = 'scale(1)'; /* Ensure all completed steps are full size */
                });
                return; // Exit as all steps are handled
            }

            // For initial welcome message or adding new steps
            // If it's the first actual step after welcome, or subsequent steps
            if (stepIndex >= 0 && stepIndex < steps.length) {
                // Remove the initial welcome message if it exists and we're moving to the first step
                const initialWelcomeMessage = document.getElementById('initial-welcome-message');
                if (initialWelcomeMessage && stepIndex === 0 && currentStep === 0) { // Check currentStep to prevent re-removing
                    flowChartContainer.innerHTML = ''; // Clear welcome message
                }

                // If this step hasn't been rendered yet, add it to the flow chart
                if (!document.getElementById(`flow-step-${stepIndex}`)) {
                    renderFlowChart(stepIndex);
                }

                // Mark previous steps as completed (if not the very first step)
                if (stepIndex > 0) {
                    const prevFlowStep = document.getElementById(`flow-step-${stepIndex - 1}`);
                    if (prevFlowStep) {
                        prevFlowStep.classList.add('completed-flow-step');
                    }
                }

                // Highlight the current step
                const currentFlowStep = document.getElementById(`flow-step-${stepIndex}`);
                if (currentFlowStep) {
                    currentFlowStep.classList.add('active-flow-step');
                    currentFlowStep.style.opacity = '1'; /* Ensure current active step is fully visible */
                    currentFlowStep.style.transform = 'scale(1)'; /* Ensure current active step is full size */
                }
            }
        }


        function updatePhaseIndicator(phase) {
            phaseIndicator.innerHTML = phase;
        }


        function resetElements() {
            // Recalculate positions on reset to ensure responsiveness
            updatePositions(); 

            // Reset all movable elements to their initial, hidden, or default states
            pqh2_1.style.left = '100px';
            pqh2_1.style.top = `${membraneCenterY - plastoquinoneHeight / 2}px`; // Initial position inside membrane
            pqh2_1.innerHTML = 'PQH‚ÇÇ';
            pqh2_1.style.background = '#f39c12';
            pqh2_1.classList.remove('active');
            pqh2_1.style.display = 'flex';
            pqh2_1.style.opacity = '1';

            // Reset PQ pool to hidden initially
            pq_pool.style.left = '100px';
            pq_pool.style.top = `${membraneCenterY - plastoquinoneHeight / 2 + 50}px`; // Initial position slightly lower inside membrane
            pq_pool.innerHTML = 'PQ';
            pq_pool.style.background = '#95a5a6';
            pq_pool.style.display = 'none'; // Initially hidden
            pq_pool.style.opacity = '1';

            // Ensure pqh2_2 and semiquinone are reset and hidden
            pqh2_2.style.display = 'none';
            pqh2_2.style.left = '100px';
            pqh2_2.style.top = `${membraneCenterY - plastoquinoneHeight / 2}px`; // Initial position inside membrane
            pqh2_2.innerHTML = 'PQH‚ÇÇ';
            pqh2_2.style.background = '#f39c12';
            pqh2_2.classList.remove('active');
            pqh2_2.style.opacity = '1';

            semiquinone.style.display = 'none';
            semiquinone.style.left = `${qiX}px`; // Reset to Qi (stromal) position
            semiquinone.style.top = `${qiY}px`;
            semiquinone.innerHTML = 'PQ‚Ä¢‚Åª';
            semiquinone.style.background = '#e67e22';
            semiquinone.classList.remove('active');
            semiquinone.style.opacity = '1';

            // PC initial position: clearly visible in lumen, slightly below Cyt f's center
            pc.style.left = `${cytfX - (pc.offsetWidth / 2)}px`; // Centered horizontally with Cyt f
            pc.style.top = `${cytfY + (pc.offsetHeight / 2) + 15}px`; // 15px below Cyt f's bottom edge (adjusted for PC's height)
            pc.style.background = '#3498db'; // Oxidized PC color
            pc.innerHTML = 'PC';
            pc.style.opacity = '1';
            pc.style.display = 'flex';
            
            // pc2 initial position: same as pc
            pc2.style.left = `${cytfX - (pc2.offsetWidth / 2)}px`; 
            pc2.style.top = `${cytfY + (pc2.offsetHeight / 2) + 15}px`; 
            pc2.style.background = '#3498db'; // Oxidized PC color
            pc2.innerHTML = 'PC';
            pc2.style.opacity = '1';
            pc2.style.display = 'none'; // Initially hidden
            
            // Hide all electrons and protons
            const electrons = [electron1, electron2, electron3, electron4, electron5, electron6];
            electrons.forEach(e => {
                e.style.display = 'none';
                e.style.left = '50%'; // Reset position
                e.style.top = '50%';
                e.style.opacity = '1'; // Reset opacity
                e.style.zIndex = '10'; // Reset z-index
            });

            const protons = [proton1, proton2, proton3, proton4];
            protons.forEach(p => {
                p.style.display = 'none';
                // Reset positions for next cycle - for protons 1 & 2 they start at Qo bottom edge,
                // for protons 3 & 4 they start at stromaY
                p.style.left = `${qoX + (qoSite.offsetWidth / 2) - p.offsetWidth - 10}px`; // Default to Qo side
                p.style.top = `${qoY + qoSite.offsetHeight}px`; // Default to Qo side bottom

                // Special reset for protons 3 and 4 to start from stroma
                if (p.id === 'h3' || p.id === 'h4') {
                     p.style.left = `${qiX + (qiSite.offsetWidth / 2) - p.offsetWidth - 10}px`;
                     p.style.top = `${stromaY}px`;
                }
            });
            // Hide summary points on reset
            summaryPointsContainer.style.display = 'none';
            quizContainer.style.display = 'none'; // Hide quiz container on reset
            resetQuizState(); // Reset quiz visual state
        }


        function startCycle() {
            currentStep = 0;
            resetAnimation();
            nextStep();
        }

        function nextStep() {
            if (currentStep < steps.length) {
                const step = steps[currentStep];
                updateStepInfo(currentStep); // Pass currentStep for highlighting
                step.action();
                currentStep++;
            } else {
                // When animation is complete, mark all steps as completed and display final message
                updateStepInfo(steps.length); // Indicate all steps are done
                phaseIndicator.innerHTML = 'Animation Finished';
                phaseIndicator.style.background = '#28a745'; // Final green color for completion
                // Optionally stop autoplay if it's running
                if (isPlaying) {
                    toggleAutoplay();
                }
                summaryPointsContainer.style.display = 'block'; // Show summary points when animation finishes
                quizContainer.style.display = 'block'; // Show quiz container when animation finishes
            }
        }

        function resetAnimation() {
            currentStep = 0;
            resetElements(); // Call the detailed reset function
            updatePhaseIndicator('Initialization');
            phaseIndicator.style.background = '#34495e';
            renderFlowChart(0); // Re-render and reset flow chart state to initial welcome
            if (isPlaying) { // If autoplay was on, stop it and reset button text
                toggleAutoplay();
            }
            summaryPointsContainer.style.display = 'none'; // Hide summary points on reset
            quizContainer.style.display = 'none'; // Hide quiz container on reset
        }

        function toggleAutoplay() {
            const autoPlayBtn = document.querySelector('[onclick="toggleAutoplay()"]');
            if (isPlaying) {
                clearInterval(autoplayInterval);
                isPlaying = false;
                autoPlayBtn.innerHTML = 'Auto Play';
            } else {
                isPlaying = true;
                autoPlayBtn.innerHTML = 'Stop Auto';
                autoplayInterval = setInterval(() => {
                    nextStep();
                    if (currentStep >= steps.length) {
                        setTimeout(() => {
                            resetAnimation();
                            currentStep = 0;
                        }, 2000); // Wait 2 seconds before resetting after last step
                    }
                }, 3000); // 3 seconds per step
            }
        }

        // Function to render the quiz
        function renderQuiz() {
            quizForm.innerHTML = ''; // Clear previous questions
            quizQuestions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.classList.add('question-item');
                questionDiv.innerHTML = `<p class="question-text">${q.question}</p><div class="options"></div>`;
                const optionsDiv = questionDiv.querySelector('.options');

                q.options.forEach((option, optIndex) => {
                    // Remove prefix (e.g., "A) ") from the option text
                    const displayOption = option.replace(/^[A-Z]\)\s/, ''); 
                    const label = document.createElement('label');
                    label.innerHTML = `<input type="radio" name="question${index}" value="${option}"> ${displayOption}`;
                    optionsDiv.appendChild(label);
                });

                const feedbackDiv = document.createElement('div');
                feedbackDiv.classList.add('answer-feedback');
                feedbackDiv.id = `feedback-q${index}`;
                questionDiv.appendChild(feedbackDiv);

                quizForm.appendChild(questionDiv);
            });
        }

        // Function to submit quiz and show answers
        function submitQuiz() {
            quizQuestions.forEach((q, index) => {
                const selectedOption = document.querySelector(`input[name="question${index}"]:checked`);
                const feedbackDiv = document.getElementById(`feedback-q${index}`);
                feedbackDiv.style.display = 'block'; // Show feedback

                if (selectedOption) {
                    if (selectedOption.value === q.answer) {
                        feedbackDiv.innerHTML = '<strong>Correct!</strong>';
                        feedbackDiv.classList.remove('incorrect');
                        feedbackDiv.classList.add('correct');
                    } else {
                        feedbackDiv.innerHTML = `<strong>Incorrect. The correct answer is: ${q.answer}</strong>`;
                        feedbackDiv.classList.remove('correct');
                        feedbackDiv.classList.add('incorrect');
                    }
                } else {
                    feedbackDiv.innerHTML = `<strong>Please select an answer. The correct answer is: ${q.answer}</strong>`;
                    feedbackDiv.classList.remove('correct');
                    feedbackDiv.classList.add('incorrect');
                }
            });
        }

        // Function to reset quiz
        function resetQuiz() {
            quizForm.reset(); // Clear all selected radio buttons
            document.querySelectorAll('.answer-feedback').forEach(feedbackDiv => {
                feedbackDiv.style.display = 'none'; // Hide feedback
                feedbackDiv.classList.remove('correct', 'incorrect');
                feedbackDiv.innerHTML = ''; // Clear feedback text
            });
            // Re-enable radio buttons if they were disabled
            document.querySelectorAll('.quiz-container input[type="radio"]').forEach(radio => {
                radio.disabled = false;
            });
        }

        // Function to reset quiz state (called from resetElements/resetAnimation)
        function resetQuizState() {
            resetQuiz(); // Call the existing reset function for consistency
        }

        // Initialize animation on window load
        window.onload = function() {
            updatePositions(); // Call once on load to get initial positions
            renderFlowChart(0); // Render the initial welcome message in the flow chart
            renderQuiz(); // Render the quiz questions
            resetAnimation(); // Ensures everything is reset correctly and the initial state is set.
            // Add event listener for window resize to re-calculate positions
            window.addEventListener('resize', updatePositions);
        };
    </script>
</body>
</html>
