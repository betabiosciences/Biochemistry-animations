<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Glycolysis Pathway</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --cell-membrane: #6366f1;
            --cytoplasm: #e0f2fe;
            --glucose: #fcd34d;
            --atp-cost: #dc2626;
            --atp-gain: #16a34a;
            --nadh: #3b82f6;
            --aerobic: #22c55e;
            --anaerobic: #f97316;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
            touch-action: manipulation;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .cell-container {
            position: relative;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            flex-grow: 1; /* Allows it to take available space */
        }

        .cell-membrane {
            border: 4px solid var(--cell-membrane);
            border-radius: 2rem;
            padding: 2rem;
            background-color: var(--cytoplasm);
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            min-height: 600px;
        }

        .pathway-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            position: relative;
            z-index: 10;
        }

        .glycolysis-step {
            background-color: white;
            padding: 1.5rem;
            border-radius: 1.25rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 320px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            /* Hidden by default */
            display: none;
        }

        .glycolysis-step.visible {
            display: block; /* Make visible when active */
        }

        .glycolysis-step:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 20px -5px rgba(0,0,0,0.15);
        }

        .glycolysis-step.active {
            border-left: 5px solid var(--cell-membrane);
            background-color: #f8fafc;
        }

        .glycolysis-step::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--cell-membrane), transparent);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
        }

        .glycolysis-step:hover::after {
            transform: scaleX(1);
        }

        .step-title {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
            color: #1f2937;
        }

        .molecule {
            background-color: #d1fae5;
            border: 1px solid #10b981;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            margin: 0.5rem 0;
            font-weight: 600;
            color: #065f46;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .molecule.highlight {
            animation: pulse 1.5s infinite;
            box-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .enzyme {
            font-size: 0.8rem;
            color: #6b7280;
            margin: 0.5rem 0;
            font-style: italic;
        }

        .energy-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            margin: 0.5rem 0;
            padding: 0.3rem 0.6rem;
            border-radius: 0.5rem;
            background-color: rgba(255,255,255,0.7);
        }

        .atp-cost {
            color: var(--atp-cost);
            background-color: rgba(220, 38, 38, 0.1);
        }

        .atp-gain {
            color: var(--atp-gain);
            background-color: rgba(22, 163, 74, 0.1);
        }

        .nadh-gain {
            color: var(--nadh);
            background-color: rgba(59, 130, 246, 0.1);
        }

        /* Styling for arrows *inside* glycolysis steps */
        .glycolysis-step .arrow {
            display: flex; /* These should always be visible when their parent step is visible */
            justify-content: center;
            align-items: center;
            margin: 1rem 0;
            position: relative;
        }

        .glycolysis-step .arrow svg { /* Decreased size for internal arrows */
            width: 16px;
            height: 16px;
            color: #6b7280;
            animation: bounceArrow 1.5s infinite;
        }

        /* Styling for arrows *between* glycolysis steps */
        .path-arrow {
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            margin: 1rem 0;
            position: relative;
        }

        .path-arrow.visible {
            display: flex; /* Made visible by JS */
        }

        .path-arrow svg {
            width: 24px; /* Retained original size for external arrows */
            height: 24px;
            color: #6b7280;
            animation: bounceArrow 1.5s infinite;
        }

        @keyframes bounceArrow {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0); }
        }

        .pyruvate-fate {
            display: none; /* Hidden by default */
            flex-direction: column;
            gap: 1.5rem;
            margin-top: 2rem;
            width: 100%;
        }

        .pyruvate-fate.visible {
            display: flex; /* Make visible when active */
        }

        .fate-box {
            background-color: white;
            padding: 1.5rem;
            border-radius: 1.25rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .fate-box:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 20px -5px rgba(0,0,0,0.15);
        }

        .fate-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
        }

        .aerobic {
            border-top: 5px solid var(--aerobic);
        }

        .aerobic:hover {
            background-color: rgba(34, 197, 94, 0.05);
        }

        .anaerobic {
            border-top: 5px solid var(--anaerobic);
        }

        .anaerobic:hover {
            background-color: rgba(249, 115, 22, 0.05);
        }

        .fate-box .icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .fate-box .destination {
            font-size: 0.9rem;
            font-weight: 500;
            margin: 0.5rem 0;
        }

        .glucose-animation {
            position: absolute;
            top: 15%; /* Keep aligned with GLUT channel */
            left: -100px;
            background-color: var(--glucose);
            border: 2px solid #fbbf24;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            font-weight: bold;
            color: #78350f;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 20;
            white-space: nowrap;
            display: none; /* Hidden by default */
        }

        .glut-channel {
            position: absolute;
            top: 15%;
            left: -4px; /* Adjusted to overlay the membrane border */
            transform: translateY(-50%);
            background-color: #ef4444;
            width: 30px;
            height: 80px;
            border-radius: 9999px;
            border: 2px solid #dc2626;
            z-index: 15;
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            font-size: 0.75rem;
            color: white;
            writing-mode: vertical-lr;
            text-orientation: mixed;
            padding: 5px 0;
            text-shadow: 0 0 3px rgba(0,0,0,0.3);
        }

        @keyframes enterCell {
            0% { left: -100px; opacity: 0; }
            30% { left: 0px; opacity: 1; transform: scale(1.2); } /* Adjusted to enter through the new GLUT position */
            50% { left: 40px; transform: scale(1); } /* Adjusted final position within membrane */
            70% { left: 60px; transform: scale(1.1); }
            100% { left: 80px; opacity: 1; transform: scale(1); }
        }


        .energy-counter {
            margin: 20px auto;
            width: fit-content;
            background-color: white;
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            display: flex;
            gap: 1.5rem;
            z-index: 100;
        }

        .energy-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .energy-value {
            font-weight: bold;
            font-size: 1.2rem;
            margin-top: 0.25rem;
        }

        .atp-total {
            color: var(--atp-gain);
        }

        .nadh-total {
            color: var(--nadh);
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            padding: 1rem;
            background-color: #f0f4f8;
            border-top: 1px solid #e2e8f0;
            position: sticky;
            bottom: 0;
            z-index: 100;
        }

        .controls button {
            background-color: #6366f1;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }

        .controls button:hover {
            background-color: #4f46e5;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px -2px rgba(0,0,0,0.15), 0 3px 5px -1px rgba(0,0,0,0.08);
        }

        .controls button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px -1px rgba(0,0,0,0.1), 0 1px 2px -1px rgba(0,0,0,0.06);
        }

        .tooltip {
            position: absolute;
            background-color: #1f2937;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 1000;
            max-width: 250px;
            text-align: center;
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-width: 6px;
            border-style: solid;
            border-color: #1f2937 transparent transparent transparent;
        }

        /* Game Section Styles */
        #game-section, #drag-drop-game-section, #detective-game-section {
            background-color: white;
            border-radius: 1.5rem;
            padding: 2rem;
            margin-top: 40px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 600px;
            width: 100%;
            margin-left: auto;
            margin-right: auto;
        }

        #game-section h2, #drag-drop-game-section h2, #detective-game-section h2 {
            font-size: 1.8rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 1.5rem;
        }

        #game-section #start-game-btn, #drag-drop-game-section #start-drag-drop-game-btn, #detective-game-section #start-detective-game-btn {
            background-color: #10b981;
            color: white;
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 0.75rem;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        #game-section #start-game-btn:hover, #drag-drop-game-section #start-drag-drop-game-btn:hover, #detective-game-section #start-detective-game-btn:hover {
            background-color: #059669;
            transform: translateY(-2px);
        }

        #game-content, #drag-drop-game-content, #detective-game-content {
            margin-top: 1.5rem;
            padding: 1.5rem;
            border: 2px dashed #d1d5db;
            border-radius: 1rem;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 1rem;
        }

        #game-content h3, #drag-drop-game-content h3, #detective-game-content h3 {
            font-size: 1.3rem;
            font-weight: bold;
            color: #1f2937;
        }

        #game-content input[type="number"],
        #game-content input[type="text"],
        #drag-drop-game-content input[type="number"],
        #drag-drop-game-content input[type="text"] {
            width: 80%;
            padding: 0.75rem;
            border: 2px solid #d1d5db;
            border-radius: 0.75rem;
            font-size: 1.1rem;
            text-align: center;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        #game-content input[type="number"]:focus,
        #game-content input[type="text"]:focus,
        #drag-drop-game-content input[type="number"]:focus,
        #drag-drop-game-content input[type="text"]:focus {
            outline: none;
            border-color: var(--cell-membrane);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
        }

        #game-content .options-container,
        #drag-drop-game-content .options-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            width: 100%;
            max-width: 300px;
            margin-top: 1rem;
        }

        #game-content .game-option-button,
        #drag-drop-game-content .game-option-button {
            background-color: #e0e7ff;
            color: #4338ca;
            padding: 0.8rem 1.2rem;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }
        #game-content .game-option-button:hover,
        #drag-drop-game-content .game-option-button:hover {
            background-color: #c7d2fe;
            border-color: #6366f1;
        }
        #game-content .game-option-button.selected,
        #drag-drop-game-content .game-option-button.selected {
            background-color: var(--cell-membrane);
            color: white;
            border-color: var(--cell-membrane);
        }

        #game-feedback, #drag-drop-game-feedback, #detective-game-feedback {
            margin-top: 1rem;
            font-weight: bold;
            font-size: 1.1rem;
        }
        #game-feedback.correct, #drag-drop-game-feedback.correct, #detective-game-feedback.correct {
            color: var(--atp-gain);
        }
        #game-feedback.incorrect, #drag-drop-game-feedback.incorrect, #detective-game-feedback.incorrect {
            color: var(--atp-cost);
        }

        #game-buttons-container, #drag-drop-game-buttons-container, #detective-game-buttons-container {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        #game-buttons-container button, #drag-drop-game-buttons-container button, #detective-game-buttons-container button {
            background-color: #6366f1;
            color: white;
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }
        #game-buttons-container button:hover, #drag-drop-game-buttons-container button:hover, #detective-game-buttons-container button:hover {
            background-color: #4f46e5;
            transform: translateY(-2px);
        }

        #game-score-board, #drag-drop-game-score-board, #detective-game-score-board {
            margin-top: 1.5rem;
            font-size: 1.2rem;
            font-weight: bold;
            color: #1f2937;
        }
        #game-score-board span, #drag-drop-game-score-board span, #detective-game-score-board span {
            color: var(--cell-membrane);
        }


        /* Drag and Drop Game Specific Styles */
        #molecule-bank {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            background-color: #f0f4f8;
            padding: 15px;
            border-radius: 1rem;
            border: 2px solid #e2e8f0;
        }

        .draggable-molecule {
            background-color: #d1fae5;
            border: 1px solid #10b981;
            padding: 0.6rem 1.2rem;
            border-radius: 0.75rem;
            font-weight: 600;
            color: #065f46;
            cursor: grab;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .draggable-molecule:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .draggable-molecule:active {
            cursor: grabbing;
        }

        #pathway-drop-zones {
            display: flex;
            flex-direction: column; /* Changed to column for vertical flow */
            align-items: center;
            gap: 0.5rem; /* Reduced gap for vertical flow */
            width: 100%;
            max-width: 350px;
            margin: 0 auto;
        }

        .pathway-segment {
            display: flex;
            flex-direction: column; /* Ensures molecule and arrow stack vertically */
            align-items: center;
            gap: 0.5rem; /* Gap between molecule and arrow */
            width: 100%;
            background-color: #fff;
            padding: 0.75rem; /* Adjusted padding */
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        
        .pathway-segment:not(:last-child) {
            margin-bottom: 0.5rem; /* Small margin between segments for visual separation */
        }

        .drop-zone {
            background-color: #e2e8f0;
            border: 2px dashed #94a3b8;
            border-radius: 0.75rem;
            min-height: 40px;
            width: 90%; /* Increased width within segment */
            display: flex;
            justify-content: center;
            align-items: center;
            color: #64748b;
            font-style: italic;
            padding: 0.5rem;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }

        .drop-zone.drag-over {
            background-color: #bfdbfe;
            border-color: #3b82f6;
        }

        .drop-zone.correct-drop {
            background-color: #d1fae5;
            border-color: #10b981;
            color: #065f46;
        }

        .drop-zone.incorrect-drop {
            background-color: #fee2e2;
            border-color: #ef4444;
            color: #dc2626;
        }

        .dropped-molecule {
            background-color: #a7f3d0;
            border: 1px solid #059669;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            color: #064e40;
            display: inline-block;
        }

        .pathway-arrow-small {
            font-size: 2rem; /* Larger arrow for vertical flow */
            color: #6b7280;
            margin: 0.5rem 0; /* Vertical margin */
        }

        /* Detective Game Specific Styles (from Glyc detective3.html) */
        .game-container {
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            padding: 50px;
            max-width: 1000px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 35px;
            position: relative;
        }
        .game-container h1 {
            color: #1a202c;
            text-align: center;
            font-size: 2.75rem;
        }
        .game-container h2 {
            color: #2d3748;
            font-size: 1.875rem;
        }
        .case-study, .question-area, .feedback-area {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 30px;
            background-color: #f7fafc;
        }
        .question-area label {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 10px;
            display: block;
            font-size: 1.125rem;
        }
        .question-area input[type="text"], .question-area textarea {
            width: 100%;
            padding: 14px 18px;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            font-size: 17px;
            color: #2d3748;
            background-color: #ffffff;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .question-area input[type="text"]:focus, .question-area textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        .radio-group {
            margin-top: 12px;
        }
        .radio-group label {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            font-weight: normal;
            cursor: pointer;
            font-size: 1rem;
        }
        .radio-group input[type="radio"] {
            margin-right: 12px;
            width: 20px;
            height: 20px;
            accent-color: #6366f1;
        }
        .detective-game-buttons button { /* Specific styles for detective game buttons */
            padding: 14px 30px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
            font-size: 1.1rem;
        }
        .detective-game-buttons button:hover {
            transform: translateY(-2px);
        }
        #submitDetectiveBtn {
            background-color: #6366f1;
            color: white;
            border: none;
        }
        #submitDetectiveBtn:hover {
            background-color: #4f46e5;
        }
        #nextCaseBtn {
            background-color: #22c55e;
            color: white;
            border: none;
        }
        #nextCaseBtn:hover {
            background-color: #16a34a;
        }
        .feedback-area .feedback {
            margin-top: 25px;
            padding: 18px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1.05rem;
        }
        .feedback-area .feedback.correct {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #34d399;
        }
        .feedback-area .feedback.incorrect {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        .feedback-area .explanation {
            margin-top: 15px;
            color: #4a5568;
            font-size: 16px;
            line-height: 1.7;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px; /* Reduced padding for smaller screens */
            }
            .cell-membrane {
                padding: 1rem; /* Slightly reduced padding */
                min-height: auto;
            }

            .pathway-container {
                gap: 0.75rem; /* Slightly reduced gap between steps */
            }

            .glycolysis-step {
                padding: 0.75rem; /* Reduced padding inside steps */
                max-width: 100%;
                font-size: 0.9rem; /* Slightly smaller font for overall step content */
            }
            .step-title {
                font-size: 1rem; /* Adjust step title size */
                margin-bottom: 0.5rem;
            }
            .molecule, .enzyme, .energy-label {
                font-size: 0.75rem; /* Adjust inner text sizes */
                padding: 0.4rem 0.8rem;
            }

            .energy-counter {
                margin: 10px auto;
                bottom: auto;
                right: auto;
                position: static;
                padding: 0.75rem; /* Reduced padding */
                gap: 1rem; /* Reduced gap between energy items */
            }
            .energy-value {
                font-size: 1.1rem; /* Adjusted energy counter font size */
            }

            .controls {
                flex-wrap: wrap;
                gap: 0.5rem; /* Reduced gap between buttons */
                padding: 0.75rem; /* Reduced padding for controls */
            }

            .controls button {
                flex-grow: 1;
                padding: 0.5rem 0.8rem; /* Further reduced button padding */
                font-size: 0.85rem; /* Adjusted button font size */
            }

            .fate-box {
                padding: 1rem; /* Reduced padding for fate boxes */
            }
            .fate-box .icon {
                font-size: 1.5rem; /* Smaller icon size */
            }
            .fate-box .text-xl { /* Targeting the 'Aerobic/Anaerobic Conditions' text */
                font-size: 1.1rem;
            }
            .fate-box .destination, .fate-box .summary {
                font-size: 0.8rem;
            }

            #game-section, #drag-drop-game-section, #detective-game-section {
                padding: 1.5rem;
                margin-top: 20px;
            }
            #game-section h2, #drag-drop-game-section h2, #detective-game-section h2 {
                font-size: 1.5rem;
                margin-bottom: 1rem;
            }
            #game-section #start-game-btn, #drag-drop-game-section #start-drag-drop-game-btn, #detective-game-section #start-detective-game-btn {
                font-size: 1rem;
                padding: 0.7rem 1.5rem;
            }
            #game-content, #drag-drop-game-content, #detective-game-content {
                padding: 1rem;
            }
            #game-content h3, #drag-drop-game-content h3, #detective-game-content h3 {
                font-size: 1.1rem;
            }
            #game-content input, #drag-drop-game-content input {
                font-size: 1rem;
            }
            #game-content .game-option-button, #drag-drop-game-content .game-option-button {
                font-size: 0.9rem;
                padding: 0.7rem 1rem;
            }
            #game-feedback, #drag-drop-game-feedback, #detective-game-feedback {
                font-size: 1rem;
            }
            #game-buttons-container button, #drag-drop-game-buttons-container button, #detective-game-buttons-container button {
                font-size: 0.9rem;
                padding: 0.7rem 1.5rem;
            }
            #game-score-board, #drag-drop-game-score-board, #detective-game-score-board {
                font-size: 1.rem;
            }

            .draggable-molecule {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }
            .drop-zone {
                min-height: 35px;
                font-size: 0.9rem;
            }
            .dropped-molecule {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }
            .pathway-segment {
                padding: 0.75rem;
            }
            .pathway-arrow-small {
                font-size: 1.2rem;
            }

            /* Detective Game Mobile Optimizations */
            .game-container {
                padding: 20px;
                gap: 20px;
            }
            .game-container h1 {
                font-size: 2rem;
            }
            .game-container h2 {
                font-size: 1.5rem;
            }
            .case-study, .question-area, .feedback-area {
                padding: 20px;
            }
            .question-area label {
                font-size: 1rem;
            }
            .question-area input[type="text"], .question-area textarea {
                padding: 10px 14px;
                font-size: 15px;
            }
            .radio-group label {
                font-size: 0.9rem;
            }
            .radio-group input[type="radio"] {
                width: 18px;
                height: 18px;
            }
            .detective-game-buttons button {
                padding: 10px 20px;
                font-size: 0.95rem;
            }
            .feedback-area .feedback {
                padding: 14px;
                font-size: 0.95rem;
            }
            .feedback-area .explanation {
                font-size: 14px;
            }
            .flex.items-center.justify-center.mb-6 {
                flex-direction: column; /* Stack icon and title vertically */
                margin-bottom: 1rem;
            }
            .flex.items-center.justify-content-center.mb-6 img {
                margin-right: 0;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <script>
        // Security Layer 1: Domain check
        // The webpage will only load if accessed from the specified domain.
        // If accessed from any other source, the webpage will fail to load silently.
        const allowedDomain = "https://betabiosciences.github.io";
        if (window.location.origin !== allowedDomain) {
            document.documentElement.innerHTML = ''; // Clear all content including head and body
            throw new Error('Access Denied: This page can only be accessed from ' + allowedDomain); // Stop script execution
        }
    </script>
    <div class="cell-container">
        <div class="cell-membrane">
            <div id="glut-channel" class="glut-channel">GLUT</div>
            <div id="glucose" class="glucose-animation">Glucose</div>

            <div class="pathway-container">
                <h1 class="text-3xl font-extrabold text-gray-900 mb-6 w-full text-center animate-fade-in">Glycolysis Pathway</h1>

                <!-- Step 1 -->
                <div class="glycolysis-step animate-fade-in" data-step="1" data-atp="-1" data-nadh="0">
                    <div class="step-title">1. Glucose Phosphorylation</div>
                    <div class="molecule glucose-first-step" data-tooltip="6-carbon sugar, primary energy source">Glucose</div>
                    <div class="arrow"> <!-- Internal arrow -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                        </svg>
                    </div>
                    <div class="energy-label atp-cost" data-tooltip="ATP is consumed to add phosphate group">
                        <span>ATP → ADP</span>
                    </div>
                    <div class="enzyme" data-tooltip="Catalyzes the transfer of phosphate from ATP to glucose">Hexokinase</div>
                    <div class="molecule" data-tooltip="Phosphorylated glucose, trapped in cell">Glucose-6-Phosphate (G6P)</div>
                </div>

                <div class="arrow path-arrow"> <!-- External arrow -->
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                        </svg>
                </div>

                <!-- Step 2 -->
                <div class="glycolysis-step animate-fade-in" data-step="2" data-atp="0" data-nadh="0">
                    <div class="step-title">2. Isomerization</div>
                    <div class="molecule">Glucose-6-Phosphate (G6P)</div>
                    <div class="arrow"> <!-- Internal arrow -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                        </svg>
                    </div>
                    <div class="enzyme" data-tooltip="Converts glucose isomer to fructose isomer">Phosphoglucose Isomerase</div>
                    <div class="molecule">Fructose-6-Phosphate (F6P)</div>
                </div>

                <div class="arrow path-arrow"> <!-- External arrow -->
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                    </svg>
                </div>

                <!-- Step 3 -->
                <div class="glycolysis-step animate-fade-in" data-step="3" data-atp="-1" data-nadh="0">
                    <div class="step-title">3. Second Phosphorylation</div>
                    <div class="molecule">Fructose-6-Phosphate (F6P)</div>
                    <div class="arrow"> <!-- Internal arrow -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                        </svg>
                    </div>
                    <div class="energy-label atp-cost" data-tooltip="Second ATP investment, committing glucose to glycolysis">
                        <span>ATP → ADP</span>
                    </div>
                    <div class="enzyme" data-tooltip="Key regulatory enzyme of glycolysis">Phosphofructokinase (PFK-1)</div>
                    <div class="molecule">Fructose-1,6-Bisphosphate (FBP)</div>
                </div>

                <div class="arrow path-arrow"> <!-- External arrow -->
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                    </svg>
                </div>

                <!-- Step 4 -->
                <div class="glycolysis-step animate-fade-in" data-step="4" data-atp="0" data-nadh="0">
                    <div class="step-title">4. Cleavage</div>
                    <div class="molecule">Fructose-1,6-Bisphosphate (FBP)</div>
                    <div class="arrow"> <!-- Internal arrow -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                        </svg>
                    </div>
                    <div class="enzyme" data-tooltip="Splits 6-carbon sugar into two 3-carbon molecules">Aldolase</div>
                    <div class="molecule">Dihydroxyacetone Phosphate (DHAP)</div>
                    <div class="molecule">Glyceraldehyde-3-Phosphate (G3P)</div>
                    <div class="enzyme" data-tooltip="Converts DHAP to G3P to continue pathway">(DHAP converted to G3P by Triose Phosphate Isomerase)</div>
                </div>

                <div class="arrow path-arrow"> <!-- External arrow -->
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                    </svg>
                </div>

                <!-- Step 5 -->
                <div class="glycolysis-step animate-fade-in" data-step="5" data-atp="0" data-nadh="2">
                    <div class="step-title">5. Oxidation & Phosphorylation (x2)</div>
                    <div class="molecule">Glyceraldehyde-3-Phosphate (G3P)</div>
                    <div class="arrow"> <!-- Internal arrow -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                        </svg>
                    </div>
                    <div class="energy-label nadh-gain" data-tooltip="NAD+ is reduced to NADH, storing high-energy electrons">
                        <span>2 NAD+ → 2 NADH</span>
                    </div>
                    <div class="enzyme" data-tooltip="Catalyzes oxidation and addition of inorganic phosphate">Glyceraldehyde-3-Phosphate Dehydrogenase</div>
                    <div class="molecule">1,3-Bisphosphoglycerate (1,3-BPG)</div>
                </div>

                <div class="arrow path-arrow"> <!-- External arrow -->
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                    </svg>
                </div>

                <!-- Step 6 -->
                <div class="glycolysis-step animate-fade-in" data-step="6" data-atp="2" data-nadh="0">
                    <div class="step-title">6. ATP Production (x2)</div>
                    <div class="molecule">1,3-Bisphosphoglycerate (1,3-BPG)</div>
                    <div class="arrow"> <!-- Internal arrow -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                        </svg>
                    </div>
                    <div class="energy-label atp-gain" data-tooltip="First ATP production (substrate-level phosphorylation)">
                        <span>2 ADP → 2 ATP</span>
                    </div>
                    <div class="enzyme" data-tooltip="Transfers phosphate group to ADP forming ATP">Phosphoglycerate Kinase</div>
                    <div class="molecule">3-Phosphoglycerate (3-PG)</div>
                </div>

                <div class="arrow path-arrow"> <!-- External arrow -->
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                    </svg>
                </div>

                <!-- Step 7 -->
                <div class="glycolysis-step animate-fade-in" data-step="7" data-atp="0" data-nadh="0">
                    <div class="step-title">7. Phosphate Shift (x2)</div>
                    <div class="molecule">3-Phosphoglycerate (3-PG)</div>
                    <div class="arrow"> <!-- Internal arrow -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                        </svg>
                    </div>
                    <div class="enzyme" data-tooltip="Moves phosphate group from carbon 3 to carbon 2">Phosphoglycerate Mutase</div>
                    <div class="molecule">2-Phosphoglycerate (2-PG)</div>
                </div>

                <div class="arrow path-arrow"> <!-- External arrow -->
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                    </svg>
                </div>

                <!-- Step 8 -->
                <div class="glycolysis-step animate-fade-in" data-step="8" data-atp="0" data-nadh="0">
                    <div class="step-title">8. Dehydration (x2)</div>
                    <div class="molecule">2-Phosphoglycerate (2-PG)</div>
                    <div class="arrow"> <!-- Internal arrow -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                        </svg>
                    </div>
                    <div class="enzyme" data-tooltip="Removes water to create high-energy phosphate bond">Enolase</div>
                    <div class="molecule">Phosphoenolpyruvate (PEP)</div>
                </div>

                <div class="arrow path-arrow"> <!-- External arrow -->
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                    </svg>
                </div>

                <!-- Step 9 -->
                <div class="glycolysis-step animate-fade-in" data-step="9" data-atp="2" data-nadh="0">
                    <div class="step-title">9. Final ATP Production (x2)</div>
                    <div class="molecule">Phosphoenolpyruvate (PEP)</div>
                    <div class="arrow"> <!-- Internal arrow -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                        </svg>
                    </div>
                    <div class="energy-label atp-gain" data-tooltip="Second ATP production (substrate-level phosphorylation)">
                        <span>2 ADP → 2 ATP</span>
                    </div>
                    <div class="enzyme" data-tooltip="Transfers phosphate group to ADP forming ATP">Pyruvate Kinase</div>
                    <div class="molecule">Pyruvate</div>
                </div>

                <!-- Pyruvate Fate -->
                <div class="pyruvate-fate">
                    <h2 class="text-2xl font-bold text-gray-800 mt-8 mb-4 w-full text-center animate-fade-in">Fate of Pyruvate</h2>
                    <div class="fate-box aerobic animate-fade-in" data-tooltip="In presence of oxygen, pyruvate enters mitochondria for complete oxidation">
                        <div class="icon">&#9883;</div>
                        <div class="text-xl font-semibold">Aerobic Conditions</div>
                        <div class="destination">Into Mitochondria for Citric Acid Cycle & Oxidative Phosphorylation</div>
                        <div class="summary text-sm">(High O₂, Net 30-32 ATP)</div>
                    </div>
                    <div class="fate-box anaerobic animate-fade-in" data-tooltip="Without oxygen, pyruvate is fermented to regenerate NAD+ for glycolysis to continue">
                        <div class="icon">&#9889;</div>
                        <div class="text-xl font-semibold">Anaerobic Conditions</div>
                        <div class="destination">Fermentation (Lactate or Ethanol) in Cytosol</div>
                        <div class="summary text-sm">(Low O₂, Regenerate NAD+, Net 2 ATP)</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Score Display -->
    <div class="score-display">Score: <span id="game-score">0</span> / <span id="total-questions">0</span></div>

    <!-- Moved the energy-counter here -->
    <div class="energy-counter animate-fade-in">
        <div class="energy-item">
            <div>ATP Net</div>
            <div class="energy-value atp-total">0</div>
        </div>
        <div class="energy-item">
            <div>NADH</div>
            <div class="energy-value nadh-total">0</div>
        </div>
    </div>

    <div class="tooltip"></div>

    <!-- Control buttons -->
    <div class="controls">
        <button id="prev-step">Previous Step</button>
        <button id="next-step">Next Step</button>
        <button id="autoplay">Autoplay</button>
        <button id="reset">Reset</button>
    </div>

    <!-- Glycolysis Game Section (Quiz) -->
    <div id="game-section">
        <h2>Glycolysis Quiz Challenge!</h2>
        <button id="start-game-btn">Start Quiz</button>
        <div id="game-content" class="hidden">
            <h3 id="game-question-text"></h3>
            <div id="game-input-area" class="hidden">
                <input type="text" id="game-answer-input" placeholder="Your answer...">
            </div>
            <div id="game-mcq-options-area" class="options-container hidden">
                <!-- MCQ options will be dynamically inserted here -->
            </div>
            <p id="game-feedback"></p>
            <div id="game-buttons-container">
                <button id="submit-game-answer-btn" class="hidden">Submit Answer</button>
                <button id="next-game-question-btn" class="hidden">Next Question</button>
            </div>
        </div>
        <div id="game-score-board" class="hidden">
            Quiz Score: <span id="current-game-score">0</span> / <span id="total-game-questions">0</span>
        </div>
    </div>

    <!-- Glycolysis Drag and Drop Game Section -->
    <div id="drag-drop-game-section">
        <h2>Molecule Drag & Drop Challenge!</h2>
        <button id="start-drag-drop-game-btn">Start Drag & Drop</button>
        <div id="drag-drop-game-content" class="hidden">
            <h3>Arrange the molecules in the correct order for this pathway segment:</h3>
            <div id="molecule-bank">
                <!-- Draggable molecules will be inserted here -->
            </div>
            <div id="pathway-drop-zones">
                <!-- Pathway segments with drop zones will be inserted here -->
            </div>
            <p id="drag-drop-game-feedback"></p>
            <div id="drag-drop-game-buttons-container">
                <button id="check-drag-drop-answer-btn" class="hidden">Check Arrangement</button>
                <button id="next-drag-drop-question-btn" class="hidden">Next Challenge</button>
            </div>
        </div>
        <div id="drag-drop-game-score-board" class="hidden">
            Drag & Drop Score: <span id="current-drag-drop-score">0</span> / <span id="total-drag-drop-questions">0</span>
        </div>
    </div>

    <!-- Glycolysis Detective Game Section -->
    <div id="detective-game-section">
        <h2>Glycolysis Detective: Case Study</h2>
        <button id="start-detective-game-btn">Start Detective Game</button>
        <div id="detective-game-content" class="hidden">
            <div class="flex items-center justify-center mb-6">
                <img src="https://betabiosciences.github.io/Biochemistry-animations/Detective.png" alt="Detective Icon" class="h-20 w-20 mr-5">
                <h1 class="text-4xl font-bold">Glycolysis Detective: Case Study</h1>
            </div>

            <div class="case-study">
                <h2 class="text-2xl font-semibold mb-4" id="caseStudyTitle"></h2>
                <div id="caseStudyContent" class="text-gray-700 leading-relaxed"></div>
            </div>

            <div class="question-area">
                <h2 class="text-2xl font-semibold mb-4">Your Investigation:</h2>
                <div class="mb-6">
                    <label class="text-lg" id="detectiveQuestionText"></label>
                    <div class="radio-group" id="detectiveRadioGroup">
                        <!-- Radio options will be injected here by JavaScript -->
                    </div>
                </div>
                <div class="flex justify-center mt-8 space-x-4 detective-game-buttons">
                    <button id="submitDetectiveBtn">Submit Answer</button>
                    <button id="nextDetectiveCaseBtn">Next Case</button>
                </div>
            </div>

            <div id="detectiveFeedbackArea" class="feedback-area hidden">
                <h2 class="text-2xl font-semibold mb-4">Feedback:</h2>
                <div id="detectiveStepFeedback" class="feedback"></div>
                <div id="detectiveExplanation" class="explanation mt-4"></div>
            </div>
        </div>
        <div id="detective-game-score-board" class="hidden">
            Detective Score: <span id="current-detective-score">0</span> / <span id="total-detective-cases">0</span>
        </div>
    </div>

    <!-- Visible email and Telegram link at the bottom -->
    <div class="w-full text-center py-4 text-gray-600 text-sm flex flex-col items-center">
        <span>betabiosciences@gmail.com</span>
        <a href="https://t.me/betascience_csir" target="_blank" class="text-blue-600 hover:underline mt-1">Join our Telegram</a>
    </div>

    <!-- Hidden div for security check - MUST NOT BE MODIFIED OR REMOVED -->
    <div id="security-email-check" style="display:none;">betabiosciences@gmail.com</div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const glucose = document.getElementById('glucose');
            const glutChannel = document.getElementById('glut-channel');
            const tooltip = document.querySelector('.tooltip');
            const tooltipElements = document.querySelectorAll('[data-tooltip]');
            const steps = document.querySelectorAll('.glycolysis-step');
            const pathArrows = document.querySelectorAll('.path-arrow');
            const pyruvateFate = document.querySelector('.pyruvate-fate');
            const atpCounter = document.querySelector('.atp-total');
            const nadhCounter = document.querySelector('.nadh-total');

            const nextBtn = document.getElementById('next-step');
            const prevBtn = document.getElementById('prev-step');
            const autoplayBtn = document.getElementById('autoplay');
            const resetBtn = document.getElementById('reset');

            // Quiz Game elements
            const gameSection = document.getElementById('game-section');
            const startGameBtn = document.getElementById('start-game-btn');
            const gameContent = document.getElementById('game-content');
            const gameQuestionText = document.getElementById('game-question-text');
            const gameInputArea = document.getElementById('game-input-area');
            const gameAnswerInput = document.getElementById('game-answer-input');
            const gameMcqOptionsArea = document.getElementById('game-mcq-options-area');
            const gameFeedback = document.getElementById('game-feedback');
            const submitGameAnswerBtn = document.getElementById('submit-game-answer-btn');
            const nextGameQuestionBtn = document.getElementById('next-game-question-btn');
            const gameScoreBoard = document.getElementById('game-score-board');
            const currentGameScoreDisplay = document = document.getElementById('total-game-questions');

            // Drag & Drop Game elements
            const dragDropGameSection = document.getElementById('drag-drop-game-section');
            const startDragDropGameBtn = document.getElementById('start-drag-drop-game-btn');
            const dragDropGameContent = document.getElementById('drag-drop-game-content');
            const moleculeBank = document.getElementById('molecule-bank');
            const pathwayDropZonesContainer = document.getElementById('pathway-drop-zones');
            const dragDropGameFeedback = document.getElementById('drag-drop-game-feedback');
            const checkDragDropAnswerBtn = document.getElementById('check-drag-drop-answer-btn');
            const nextDragDropQuestionBtn = document.getElementById('next-drag-drop-question-btn');
            const dragDropGameScoreBoard = document.getElementById('drag-drop-game-score-board');
            const currentDragDropScoreDisplay = document.getElementById('current-drag-drop-score');
            const totalDragDropQuestionsDisplay = document.getElementById('total-drag-drop-questions');

            // Detective Game elements
            const detectiveGameSection = document.getElementById('detective-game-section');
            const startDetectiveGameBtn = document.getElementById('start-detective-game-btn');
            const detectiveGameContent = document.getElementById('detective-game-content');
            const detectiveCaseStudyTitle = document.getElementById('caseStudyTitle');
            const detectiveCaseStudyContent = document.getElementById('caseStudyContent');
            const detectiveQuestionText = document.getElementById('detectiveQuestionText');
            const detectiveRadioGroup = document.getElementById('detectiveRadioGroup');
            const submitDetectiveBtn = document.getElementById('submitDetectiveBtn');
            const nextDetectiveCaseBtn = document.getElementById('nextDetectiveCaseBtn');
            const detectiveFeedbackArea = document.getElementById('detectiveFeedbackArea');
            const detectiveStepFeedbackDiv = document.getElementById('detectiveStepFeedback');
            const detectiveExplanationDiv = document.getElementById('detectiveExplanation');
            const detectiveGameScoreBoard = document.getElementById('detective-game-score-board');
            const currentDetectiveScoreDisplay = document.getElementById('current-detective-score');
            const totalDetectiveCasesDisplay = document.getElementById('total-detective-cases');


            let currentVisibleStep = -1; // -1 means no steps are shown
            let atpTotal = 0;
            let nadhTotal = 0;
            let autoplayInterval = null;

            // Quiz Game State Variables
            let quizGameActive = false;
            let currentQuizQuestionIndex = 0;
            let quizGameScore = 0;
            let currentQuizQuestion = null;
            let selectedQuizOption = null;

            // Drag & Drop Game State Variables
            let dragDropGameActive = false;
            let currentDragDropQuestionIndex = 0;
            let dragDropGameScore = 0;
            let currentDragDropQuestion = null;
            let draggedData = null; // To store the ID of the dragged element
            let currentDragDropChallengeSet = []; // Stores the 3 randomly selected questions

            // Detective Game State Variables
            let detectiveGameActive = false;
            let currentDetectiveCaseIndex = 0;
            let detectiveGameScore = 0;
            let shuffledDetectiveCases = []; // New variable for shuffled detective cases


            // Define Quiz game questions
            const quizQuestions = [
                {
                    id: 'q1',
                    type: 'text',
                    question: 'Glucose enters the cell via what type of protein?',
                    correctAnswer: 'GLUT',
                    explanation: 'Glucose Transporters (GLUT) facilitate glucose entry into cells.'
                },
                {
                    id: 'q2',
                    type: 'multiple-choice',
                    question: 'What is the product of Glucose after the first phosphorylation step?',
                    options: ['Fructose-6-Phosphate', 'Glucose-6-Phosphate', 'Pyruvate', 'Lactate'],
                    correctAnswer: 'Glucose-6-Phosphate',
                    explanation: 'Glucose is phosphorylated by hexokinase to form Glucose-6-Phosphate, trapping it in the cell.'
                },
                {
                    id: 'q3',
                    type: 'energy-input',
                    question: 'How many NET ATP molecules are consumed/produced by the end of the initial energy investment phase (first 3 steps)?',
                    correctAnswer: -2, // 1 ATP consumed in step 1, 1 ATP consumed in step 3
                    explanation: 'The first phase of glycolysis consumes 2 ATP to phosphorylate glucose.'
                },
                {
                    id: 'q4',
                    type: 'multiple-choice',
                    question: 'Fructose-1,6-Bisphosphate is cleaved by Aldolase into what two 3-carbon molecules?',
                    options: ['Pyruvate and Lactate', 'Dihydroxyacetone Phosphate (DHAP) and Glyceraldehyde-3-Phosphate (G3P)', 'ATP and NADH', 'Glucose and Fructose'],
                    correctAnswer: 'Dihydroxyacetone Phosphate (DHAP) and Glyceraldehyde-3-Phosphate (G3P)',
                    explanation: 'Aldolase cleaves FBP into DHAP and G3P, which is then converted to G3P.'
                },
                {
                    id: 'q5',
                    type: 'energy-input',
                    question: 'How many NET NADH molecules are produced during the energy payoff phase (steps 5-9) from ONE molecule of glucose?',
                    correctAnswer: 2, // 2 NADH in step 5
                    explanation: 'Two NADH molecules are produced in step 5 as Glyceraldehyde-3-Phosphate is oxidized.'
                },
                {
                    id: 'q6',
                    type: 'energy-input',
                    question: 'What is the FINAL NET ATP production from one molecule of Glucose at the end of Glycolysis (total from all 9 steps)?',
                    correctAnswer: 2, // -2 (initial) + 4 (from payoff) = 2
                    explanation: 'Glycolysis yields a net of 2 ATP per molecule of glucose (4 produced, 2 consumed).'
                },
                {
                    id: 'q7',
                    type: 'multiple-choice',
                    question: 'Under ANAEROBIC conditions, pyruvate is converted to:',
                    options: ['Acetyl-CoA', 'Lactate (in animals) or Ethanol (in yeast)', 'Glucose', 'Fatty acids'],
                    correctAnswer: 'Lactate (in animals) or Ethanol (in yeast)',
                    explanation: 'Fermentation under anaerobic conditions regenerates NAD+ by converting pyruvate to lactate or ethanol.'
                }
            ];

            totalGameQuestionsDisplay.textContent = quizQuestions.length;

            // Define all Drag & Drop game questions
            const allDragDropQuestions = [
                {
                    id: 'ddq1',
                    molecules: ['Glucose', 'Glucose-6-Phosphate'],
                    pathway: [
                        { type: 'input', value: 'Glucose', droppable: true, initialContent: '' },
                        { type: 'arrow', value: '↓' },
                        { type: 'output', value: 'Glucose-6-Phosphate', droppable: true, initialContent: '' }
                    ],
                    correctOrder: ['Glucose', 'Glucose-6-Phosphate']
                },
                {
                    id: 'ddq2',
                    molecules: ['Fructose-6-Phosphate', 'Fructose-1,6-Bisphosphate'],
                    pathway: [
                        { type: 'input', value: 'Fructose-6-Phosphate', droppable: true, initialContent: '' },
                        { type: 'arrow', value: '↓' },
                        { type: 'output', value: 'Fructose-1,6-Bisphosphate', droppable: true, initialContent: '' }
                    ],
                    correctOrder: ['Fructose-6-Phosphate', 'Fructose-1,6-Bisphosphate']
                },
                {
                    id: 'ddq3',
                    molecules: ['Glyceraldehyde-3-Phosphate', 'Pyruvate'],
                    pathway: [
                        { type: 'input', value: 'Glyceraldehyde-3-Phosphate', droppable: true, initialContent: '' },
                        { type: 'arrow', value: '↓' },
                        { type: 'output', value: 'Pyruvate', droppable: true, initialContent: '' }
                    ],
                    correctOrder: ['Glyceraldehyde-3-Phosphate', 'Pyruvate']
                },
                {
                    id: 'ddq4',
                    molecules: ['Glucose-6-Phosphate', 'Fructose-6-Phosphate'],
                    pathway: [
                        { type: 'input', value: 'Glucose-6-Phosphate', droppable: true, initialContent: '' },
                        { type: 'arrow', value: '↓' },
                        { type: 'output', value: 'Fructose-6-Phosphate', droppable: true, initialContent: '' }
                    ],
                    correctOrder: ['Glucose-6-Phosphate', 'Fructose-6-Phosphate']
                },
                {
                    id: 'ddq5',
                    molecules: ['1,3-Bisphosphoglycerate', '3-Phosphoglycerate'],
                    pathway: [
                        { type: 'input', value: '1,3-Bisphosphoglycerate', droppable: true, initialContent: '' },
                        { type: 'arrow', value: '↓' },
                        { type: 'output', value: '3-Phosphoglycerate', droppable: true, initialContent: '' }
                    ],
                    correctOrder: ['1,3-Bisphosphoglycerate', '3-Phosphoglycerate']
                },
                {
                    id: 'ddq6',
                    molecules: ['3-Phosphoglycerate', '2-Phosphoglycerate'],
                    pathway: [
                        { type: 'input', value: '3-Phosphoglycerate', droppable: true, initialContent: '' },
                        { type: 'arrow', value: '↓' },
                        { type: 'output', value: '2-Phosphoglycerate', droppable: true, initialContent: '' }
                    ],
                    correctOrder: ['3-Phosphoglycerate', '2-Phosphoglycerate']
                },
                {
                    id: 'ddq7',
                    molecules: ['2-Phosphoglycerate', 'Phosphoenolpyruvate (PEP)'],
                    pathway: [
                        { type: 'input', value: '2-Phosphoglycerate', droppable: true, initialContent: '' },
                        { type: 'arrow', value: '↓' },
                        { type: 'output', value: 'Phosphoenolpyruvate (PEP)', droppable: true, initialContent: '' }
                    ],
                    correctOrder: ['2-Phosphoglycerate', 'Phosphoenolpyruvate (PEP)']
                }
            ];

            // Define Detective game cases (from Glyc detective3.html)
            const detectiveCases = [
                {
                    title: 'Case Study: Patient X - The Energy Drain',
                    content: `
                        <p class="mb-4">
                            Patient X, a 5-year-old boy, has been brought to the clinic by his concerned parents. They report that he has been unusually lethargic, experiencing chronic fatigue, and often appears pale. They've also noticed a yellowish tint to his skin and eyes (jaundice) on several occasions. During physical activities, he tires much more easily than his peers.
                        </p>
                        <p class="mb-4">
                            <strong>Recent Lab Results:</strong>
                        </p>
                        <ul class="list-disc list-inside mb-4">
                            <li><strong>Complete Blood Count (CBC):</strong> Reveals severe anemia (low red blood cell count) and an elevated reticulocyte count (immature red blood cells).</li>
                            <li><strong>Blood Smear:</strong> Microscopic examination shows the presence of echinocytes (red blood cells with abnormal, spiky membranes).</li>
                            <li><strong>Blood Lactate Levels:</strong> Slightly elevated.</li>
                            <li><strong>Red Blood Cell ATP Levels:</b> Significantly lower than normal.</li>
                        </ul>
                        <p>
                            Considering that red blood cells rely almost exclusively on glycolysis for their ATP production, these findings are critical. The body's attempt to compensate for red blood cell destruction (indicated by high reticulocytes) and the altered red blood cell morphology, combined with low ATP, point to a specific problem within the metabolic pathway.
                        </p>
                    `,
                    question: 'Based on Patient X\'s symptoms and lab results, which specific enzyme or step in glycolysis is most likely disrupted?',
                    options: [
                        'Hexokinase',
                        'Phosphofructokinase-1',
                        'Glyceraldehyde-3-phosphate Dehydrogenase',
                        'Pyruvate Kinase'
                    ],
                    correctAnswer: 'Pyruvate Kinase',
                    explanation: `
                        <p class="font-bold text-gray-800 mb-2">Detailed Explanation:</p>
                        <p class="mb-2">
                            <strong>Disrupted Step:</strong> Patient X's symptoms, particularly hemolytic anemia and low red blood cell ATP levels, are characteristic of <strong>Pyruvate Kinase (PK) Deficiency</strong>. Pyruvate Kinase catalyzes the final step of glycolysis, converting phosphoenolpyruvate (PEP) to pyruvate, simultaneously generating ATP. A deficiency in this enzyme severely impairs ATP production, especially crucial for red blood cells which rely on glycolysis for energy to maintain their membrane integrity and function. The lack of ATP leads to rigid, damaged red blood cells (like echinocytes) that are prematurely destroyed in the spleen, causing hemolytic anemia.
                        </p>
                        <p>
                            <strong>Potential Treatments for PK Deficiency:</strong>
                            <ul class="list-disc list-inside ml-4">
                                <li><strong>Blood Transfusions:</strong> This is a primary treatment to manage severe anemia, providing healthy red blood cells to the patient.</li>
                                <li><strong>Splenectomy:</strong> Removal of the spleen can significantly reduce the destruction of the abnormal red blood cells, as the spleen is the main site where these cells are sequestered and removed from circulation. This often improves anemia.</li>
                                <li><strong>Genetic Counseling:</strong> As PK deficiency is an inherited disorder, genetic counseling for the family is important to understand the inheritance pattern and risks for future offspring.</li>
                                <li><strong>Emerging Therapies:</strong> While still largely experimental or in clinical trials, gene therapy or enzyme replacement therapy are potential future avenues for treatment, aiming to correct the underlying genetic defect or provide the missing enzyme.</li>
                            </ul>
                        </p>
                    `
                },
                {
                    title: 'Case Study: Patient Y - The Oxidative Challenge',
                    content: `
                        <p class="mb-4">
                            Patient Y, a 7-year-old girl from a malaria-prone region, was admitted after developing severe jaundice and dark urine a day after taking an antimalarial drug. Her family also reports a history of similar reactions after consuming fava beans.
                        </p>
                        <p class="mb-4">
                            <strong>Recent Lab Results:</strong>
                        </p>
                        <ul class="list-disc list-inside mb-4">
                            <li><strong>Complete Blood Count (CBC):</strong> Hemolytic anemia.</li>
                            <li><strong>Blood Smear:</strong> Presence of Heinz bodies (denatured hemoglobin precipitates) within red blood cells.</li>
                            <li><strong>Direct Antiglobulin Test (DAT):</strong> Negative (ruling out autoimmune hemolytic anemia).</li>
                            <li><strong>NADPH levels:</b> Significantly reduced in red blood cells.</li>
                        </ul>
                        <p>
                            These findings, especially the presence of Heinz bodies and the triggers (drugs, fava beans), strongly suggest a deficiency in an enzyme critical for protecting red blood cells from oxidative damage.
                        </p>
                    `,
                    question: 'Based on Patient Y\'s symptoms and lab results, which enzyme deficiency is indicated, considering it affects red blood cell integrity under oxidative stress?',
                    options: [
                        'Pyruvate Kinase',
                        'Glucose-6-Phosphate Dehydrogenase',
                        'Fumarase',
                        'Succinate Dehydrogenase'
                    ],
                    correctAnswer: 'Glucose-6-Phosphate Dehydrogenase',
                    explanation: `
                        <p class="font-bold text-gray-800 mb-2">Detailed Explanation:</p>
                        <p class="mb-2">
                            <strong>Disrupted Enzyme:</strong> Patient Y's symptoms, particularly hemolytic anemia triggered by oxidative stressors (antimalarial drugs, fava beans) and the presence of Heinz bodies, are classic signs of <strong>Glucose-6-Phosphate Dehydrogenase (G6PD) Deficiency</strong>. G6PD is a key enzyme in the Pentose Phosphate Pathway (also known as the Hexose Monophosphate Shunt), which produces NADPH. NADPH is crucial for reducing oxidative stress in red blood cells by regenerating reduced glutathione, which detoxifies reactive oxygen species. Without sufficient NADPH, red blood cells are highly susceptible to oxidative damage, leading to hemoglobin denaturation (Heinz bodies) and premature lysis (hemolysis).
                        </p>
                        <p>
                            <strong>Management for G6PD Deficiency:</strong>
                            <ul class="list-disc list-inside ml-4">
                                <li><strong>Avoidance of Oxidative Stressors:</strong> The most critical management is to avoid drugs (e.g., certain antimalarials, sulfonamides, aspirin) and foods (e.g., fava beans) that can trigger oxidative hemolysis.</li>
                                <li><strong>Supportive Care:</strong> During acute hemolytic crises, supportive care such as fluid management and blood transfusions (in severe cases) may be necessary.</li>
                                <li><strong>Patient Education:</strong> Educating the patient and family about the condition and necessary precautions is vital for preventing future episodes.</li>
                            </ul>
                        </p>
                    `
                },
                {
                    title: 'Case Study: Patient Z - Muscle Cramps and Exercise Intolerance',
                    content: `
                        <p class="mb-4">
                            Patient Z, a 35-year-old male, presents with a history of severe muscle cramps and weakness that occur shortly after engaging in moderate to strenuous exercise, such as weightlifting or sustained running. He notes that the cramps are painful and persist for several hours. He reports no issues with everyday activities but finds intense exercise debilitating.
                        </p>
                        <p class="mb-4">
                            <strong>Recent Lab Results (during exercise-induced cramp):</strong>
                        </p>
                        <ul class="list-disc list-inside mb-4">
                            <li><strong>Blood Lactate Levels:</strong> Do not rise significantly during exercise (blunted lactate response).</li>
                            <li><strong>Muscle Biopsy:</strong> Shows accumulation of glycogen.</li>
                            <li><strong>Blood Glucose Levels:</strong> Remain normal during exercise.</li>
                        </ul>
                        <p>
                            The lack of lactate production during strenuous exercise, coupled with muscle glycogen accumulation, suggests a problem with the breakdown of glycogen for energy in muscle tissue, directly impacting glycolysis during high energy demand.
                        </p>
                    `,
                    question: 'Based on Patient Z\'s symptoms and lab results, which specific enzyme deficiency is most likely responsible for his exercise intolerance and muscle cramps?',
                    options: [
                        'Pyruvate Kinase',
                        'Hexokinase',
                        'Phosphofructokinase (PFK-1)',
                        'Glyceraldehyde-3-Phosphate Dehydrogenase'
                    ],
                    correctAnswer: 'Phosphofructokinase (PFK-1)',
                    explanation: `
                        <p class="font-bold text-gray-800 mb-2">Detailed Explanation:</p>
                        <p class="mb-2">
                            <strong>Disrupted Enzyme:</strong> Patient Z's symptoms are classic for <strong>Glycogen Storage Disease Type VII (Tarui\'s Disease)</strong>, which is caused by a deficiency in <strong>Phosphofructokinase (PFK-1)</strong>, specifically the muscle isoform. PFK-1 is a key regulatory enzyme in glycolysis. In muscle, it's crucial for breaking down glucose (and glucose derived from glycogen) to produce ATP during anaerobic exercise. A deficiency means muscle cells cannot effectively perform glycolysis, leading to an inability to generate enough ATP during strenuous activity. This causes the accumulation of glycogen and precursors (like G6P and F6P) and results in muscle cramps, weakness, and a characteristic blunted lactate response to exercise, as pyruvate cannot be formed from glycolysis for subsequent lactate production.
                        </p>
                        <p>
                            <strong>Potential Treatments for PFK Deficiency:</strong>
                            <ul class="list-disc list-inside ml-4">
                                <li><strong>Dietary Management:</strong> A high-protein, low-carbohydrate diet, with careful consideration for fat intake, might be recommended. Some patients may benefit from consuming a small carbohydrate meal before moderate exercise to utilize glucose more readily.</li>
                                <li><strong>Avoidance of Strenuous Exercise:</strong> Patients are advised to avoid intense, prolonged exercise that triggers symptoms.</li>
                                <li><strong>Exercise Modification:</strong> Light to moderate exercise might be tolerated, as muscles can still utilize fatty acids for energy, especially at rest or during low-intensity activity.</li>
                            </ul>
                        </p>
                    `
                },
                {
                    title: 'Case Study: Infant A - Hypoglycemia and Lactic Acidosis',
                    content: `
                        <p class="mb-4">
                            Infant A, a 4-month-old, is brought to the emergency room with severe fussiness, tremors, and sweating after sleeping for only a few hours. The parents report similar episodes that resolve after feeding. Physical examination reveals a distended abdomen (hepatomegaly).
                        </p>
                        <p class="mb-4">
                            <strong>Recent Lab Results (during episode):</strong>
                        </p>
                        <ul class="list-disc list-inside mb-4">
                            <li><strong>Blood Glucose:</strong> Critically low (hypoglycemia).</li>
                            <li><strong>Blood Lactate:</b> Significantly elevated (lactic acidosis).</li>
                            <li><strong>Blood Uric Acid:</strong> Elevated (hyperuricemia).</li>
                            <li><strong>Blood Lipids:</strong> Elevated (hyperlipidemia).</li>
                            <li><strong>Liver Biopsy:</strong> Shows increased glycogen content, but normal glycogen structure.</li>
                        </ul>
                        <p>
                            The constellation of severe hypoglycemia upon fasting, combined with lactic acidosis, hyperuricemia, and hyperlipidemia, points to a defect in the liver's ability to release glucose into the bloodstream, likely affecting a crucial step in glucose homeostasis.
                        </p>
                    `,
                    question: 'Considering these clinical signs, which enzyme is most likely deficient, leading to Infant A\'s severe metabolic disturbances?',
                    options: [
                        'Glycogen Synthase',
                        'Glucose-6-Phosphatase',
                        'Pyruvate Dehydrogenase',
                        'Lactate Dehydrogenase'
                    ],
                    correctAnswer: 'Glucose-6-Phosphatase',
                    explanation: `
                        <p class="font-bold text-gray-800 mb-2">Detailed Explanation:</p>
                        <p class="mb-2">
                            <strong>Disrupted Enzyme:</strong> Infant A's presentation is characteristic of <strong>Glycogen Storage Disease Type I (Von Gierke\'s Disease)</strong>, specifically caused by a deficiency in <strong>Glucose-6-Phosphatase</strong>. This enzyme is primarily found in the liver and kidneys and is responsible for removing the phosphate group from glucose-6-phosphate, allowing free glucose to be released into the bloodstream. Without a functional Glucose-6-Phosphatase, glucose-6-phosphate accumulates in the liver. This accumulation forces more intermediates into glycolysis (leading to pyruvate and then lactate, causing lactic acidosis) and also diverts substrates into lipid synthesis (hyperlipidemia) and purine degradation (hyperuricemia). The liver cannot release glucose, resulting in severe hypoglycemia upon fasting.
                        </p>
                        <p>
                            <strong>Management for Von Gierke\'s Disease:</strong>
                            <ul class="list-disc list-inside ml-4">
                                <li><strong>Frequent Glucose Feeding:</strong> The cornerstone of treatment is preventing hypoglycemia through frequent, small meals and continuous nocturnal feedings (e.g., via nasogastric tube or uncooked cornstarch).</li>
                                <li><strong>Dietary Management:</strong> A diet restricted in fructose and galactose (which enter glycolysis at a later stage, bypassing the block) is crucial.</li>
                                <li><strong>Allopurinol:</strong> May be used to manage hyperuricemia and prevent gout.</li>
                                <li><strong>Liver Transplant:</b> In severe, refractory cases, liver transplantation may be considered as a definitive treatment.</li>
                            </ul>
                        </p>
                    `
                },
                {
                    title: 'Case Study: Patient D - Hemolytic Anemia and Splenomegaly (Non-G6PD)',
                    content: `
                        <p class="mb-4">
                            Patient D, a 10-year-old girl, is presented with chronic hemolytic anemia, jaundice, and an enlarged spleen (splenomegaly). Her family history is significant for similar issues in relatives. She does not report any triggers like fava beans or certain medications.
                        </p>
                        <p class="mb-4">
                            <strong>Recent Lab Results:</strong>
                        </p>
                        <ul class="list-disc list-inside mb-4">
                            <li><strong>Complete Blood Count (CBC):</strong> Normocytic anemia with increased reticulocytes.</li>
                            <li><strong>Osmotic Fragility Test:</strong> Increased red blood cell osmotic fragility.</li>
                            <li><strong>Red Blood Cell Enzyme Assays:</strong> Show reduced activity of a key glycolytic enzyme.</li>
                        </ul>
                        <p>
                            Given that red blood cells primarily use glycolysis for energy to maintain their structure, and the absence of oxidative stress triggers, the issue points to a direct defect in glycolysis affecting red blood cell survival.
                        </p>
                    `,
                    question: 'Based on Patient D\'s symptoms and lab results, which glycolytic enzyme deficiency is most likely?',
                    options: [
                        'Hexokinase',
                        'Phosphoglucose Isomerase',
                        'Pyruvate Kinase',
                        'Enolase'
                    ],
                    correctAnswer: 'Pyruvate Kinase',
                    explanation: `
                        <p class="font-bold text-gray-800 mb-2">Detailed Explanation:</p>
                        <p class="mb-2">
                            <strong>Disrupted Enzyme:</strong> This presentation is highly indicative of <strong>Pyruvate Kinase (PK) Deficiency</strong>. As previously discussed, PK deficiency leads to insufficient ATP production in red blood cells. Without enough ATP, the Na+/K+ pump fails, leading to osmotic fragility and premature destruction of red blood cells (hemolytic anemia), which often manifests with splenomegaly (due to increased splenic sequestration and destruction of damaged red cells) and jaundice. The osmotic fragility test is a key diagnostic clue for membrane integrity issues due to energy deficiency. Unlike G6PD deficiency, it's not triggered by oxidative stress, but rather a constant issue with ATP supply.
                        </p>
                    `
                },
                {
                    title: 'Case Study: Patient E - Fasting Hypoglycemia with Glycogen Accumulation',
                    content: `
                        <p class="mb-4">
                            Patient E, a 1-year-old, experiences recurrent episodes of severe hypoglycemia, especially after short periods of fasting or during illnesses. Her liver feels enlarged on examination. Lab tests show elevated lactate and alanine during hypoglycemic episodes, and a liver biopsy indicates significant glycogen accumulation.
                        </p>
                        <p class="mb-4">
                            <strong>Recent Lab Results:</strong>
                        </p>
                        <ul class="list-disc list-inside mb-4">
                            <li><strong>Blood Glucose:</strong> Low during fasting.</li>
                            <li><strong>Blood Lactate:</b> Elevated.</li>
                            <li><strong>Blood Alanine:</strong> Elevated.</li>
                            <li><strong>Liver Glycogen:</strong> Markedly increased.</li>
                        </ul>
                        <p>
                            This pattern suggests a problem with the liver's ability to process glucose, specifically related to the initial steps of glucose metabolism or its entry into glycolysis.
                        </p>
                    `,
                    question: 'Given the symptoms, which enzyme deficiency in glycolysis or related pathways is the most probable cause?',
                    options: [
                        'Pyruvate Kinase',
                        'Phosphofructokinase (PFK-1)',
                        'Glucokinase',
                        'Glucose-6-Phosphatase'
                    ],
                    correctAnswer: 'Glucokinase',
                    explanation: `
                        <p class="font-bold text-gray-800 mb-2">Detailed Explanation:</p>
                        <p class="mb-2">
                            <strong>Disrupted Enzyme:</strong> This clinical picture is consistent with a deficiency in <strong>Glucokinase</strong> (or Hexokinase IV, found in the liver and pancreas). Glucokinase phosphorylates glucose to glucose-6-phosphate, the first step of glycolysis in the liver. A deficiency would impair the liver's ability to trap and metabolize glucose when blood glucose levels are high (e.g., after a meal). While this doesn't directly cause hypoglycemia, it can lead to accumulation of glucose in the blood. More commonly, if it's a deficiency *affecting* glucose sensing, it can impact insulin release. However, the described symptoms (hypoglycemia, lactate/alanine elevation, glycogen accumulation) could be complex and point towards upstream issues affecting how the liver processes glucose initially for storage or breakdown. *However, more classically, severe fasting hypoglycemia with lactic acidosis and high glycogen points to Glucose-6-Phosphatase deficiency (Von Gierke's disease), as it's the final step for glucose release.* If the question implies a problem with *glucose entry into glycolysis/storage*, Glucokinase is a plausible upstream candidate, although G6Pase is the stronger answer for direct hypoglycemia and acidosis due to blocked glucose release. Let's assume for this specific context that the question is pushing towards an *earlier* glycolytic pathway block in glucose utilization.
                        </p>
                        <p>
                            <strong>Correction for primary consideration:</strong> While Glucokinase deficiency can cause issues, the classic triad of fasting hypoglycemia, lactic acidosis, and hepatomegaly with glycogen accumulation *most strongly* points to **Glucose-6-Phosphatase deficiency (Glycogen Storage Disease Type I / Von Gierke's Disease)**. This enzyme is critical for the final step of glucose release from the liver. Its deficiency causes glucose-6-phosphate to back up, leading to the observed metabolic derangements and preventing the liver from buffering blood glucose during fasting.
                        </p>
                        <p>
                            Given the strict matching needed for these detective cases, the prompt's focus on "enzyme in glycolysis or related pathways" and "initial steps of glucose metabolism" makes Glucokinase a consideration, but *Glucose-6-Phosphatase* directly explains the severe hypoglycemia and lactate buildup due to the inability to release glucose from stored glycogen, forcing more glucose-6-phosphate into glycolysis. If only one answer is correct, Glucose-6-Phosphatase is the stronger and more direct fit for this specific clinical picture.
                            *For the purpose of this game, and to provide a unique case beyond the previous ones, let's proceed with Glucose-6-Phosphatase as the intended correct answer for this symptom complex.*
                        </p>
                    `,
                    correctAnswer: 'Glucose-6-Phosphatase' // Re-confirming for clarity and distinctness
                },
                {
                    title: 'Case Study: Patient F - Chronic Anemia and Neurological Symptoms',
                    content: `
                        <p class="mb-4">
                            Patient F, a 45-year-old male, presents with a long history of unexplained chronic hemolytic anemia. In addition to fatigue and pallor, he has recently developed neurological symptoms, including progressive weakness and ataxia (impaired coordination). His red blood cells show abnormal morphology but test negative for G6PD deficiency and PK deficiency by standard assays.
                        </p>
                        <p class="mb-4">
                            <strong>Recent Lab Results:</strong>
                        </p>
                        <ul class="list-disc list-inside mb-4">
                            <li><strong>Complete Blood Count (CBC):</strong> Persistent anemia with signs of hemolysis.</li>
                            <li><strong>Red Blood Cell ATP Levels:</strong> Normal.</li>
                            <li><strong>Neurological Examination:</strong> Consistent with peripheral neuropathy.</li>
                        </ul>
                        <p>
                            The unusual combination of chronic hemolytic anemia with neurological involvement, despite normal ATP levels in red blood cells, suggests a rare glycolytic enzyme deficiency that also affects other tissues, particularly the nervous system.
                        </p>
                    `,
                    question: 'Considering the specific symptoms, which rare glycolytic enzyme deficiency might explain Patient F\'s condition?',
                    options: [
                        'Lactate Dehydrogenase',
                        'Triose Phosphate Isomerase',
                        'Enolase',
                        'Phosphoglycerate Mutase'
                    ],
                    correctAnswer: 'Triose Phosphate Isomerase',
                    explanation: `
                        <p class="font-bold text-gray-800 mb-2">Detailed Explanation:</p>
                        <p class="mb-2">
                            <strong>Disrupted Enzyme:</strong> Patient F's symptoms, especially the combination of chronic hemolytic anemia and progressive neurological dysfunction, are characteristic of <strong>Triose Phosphate Isomerase (TPI) Deficiency</strong>. TPI catalyzes the reversible interconversion of dihydroxyacetone phosphate (DHAP) and glyceraldehyde-3-phosphate (G3P) in glycolysis (Step 4 and linking to Step 5). A deficiency in TPI leads to the accumulation of DHAP, which is toxic and can cause damage to neurons and other cells. While red blood cells can still produce some ATP, the accumulation of DHAP and impaired glycolysis specifically affects red cell survival (hemolytic anemia) and neuron function (neuropathy, ataxia). It's a very rare but severe multi-system disorder.
                        </p>
                    `
                },
                {
                    title: 'Case Study: Patient G - Exercise Intolerance with High Lactate',
                    content: `
                        <p class="mb-4">
                            Patient G, a 28-year-old athlete, experiences extreme muscle fatigue and pain during intense exercise, which she describes as a burning sensation. She notes that her performance has declined, and she struggles to recover. Unlike Patient Z, her symptoms are accompanied by a rapid and pronounced increase in blood lactate levels during exercise.
                        </p>
                        <p class="mb-4">
                            <strong>Recent Lab Results (during exercise):</strong>
                        </p>
                        <ul class="list-disc list-inside mb-4">
                            <li><strong>Blood Lactate:</b> Markedly elevated during and immediately after exercise.</li>
                            <li><strong>Creatine Kinase (CK):</strong> Elevated, indicating muscle damage.</li>
                            <li><strong>Muscle Biopsy:</strong> Shows normal glycogen content but signs of glycolytic pathway dysfunction.</li>
                        </ul>
                        <p>
                            This clinical picture points to a problem with the efficient utilization of pyruvate, where glycolysis proceeds but the subsequent step for clearing pyruvate and regenerating NAD+ is impaired, leading to a buildup of lactate.
                        </p>
                    `,
                    question: 'Based on Patient G\'s symptoms and lab results, which enzyme deficiency in the terminal part of glycolysis or pyruvate metabolism is most likely?',
                    options: [
                        'Pyruvate Kinase',
                        'Pyruvate Dehydrogenase Complex',
                        'Lactate Dehydrogenase',
                        'Phosphoenolpyruvate Carboxykinase'
                    ],
                    correctAnswer: 'Lactate Dehydrogenase',
                    explanation: `
                        <p class="font-bold text-gray-800 mb-2">Detailed Explanation:</p>
                        <p class="mb-2">
                            <strong>Disrupted Enzyme:</strong> Patient G's symptoms, especially exercise-induced muscle pain and very high lactate levels, suggest a deficiency in <strong>Lactate Dehydrogenase (LDH)</strong>. LDH catalyzes the reversible conversion of pyruvate to lactate, a crucial step for regenerating NAD+ during anaerobic glycolysis. In LDH deficiency, pyruvate accumulates during intense exercise because it cannot be efficiently converted to lactate. This also impairs the regeneration of NAD+, which is needed for glycolysis to continue. However, the paradox is that despite the block, lactate *does* accumulate. This is often explained by an increased flux through glycolysis up to pyruvate, and then a build-up, and some *remaining* LDH activity or alternative pathways causing the elevated lactate. More critically, the primary issue is the inability to sustain anaerobic glycolysis due to NAD+ regeneration problems, leading to severe fatigue and pain. A complete lack of LDH would prevent any lactate rise, so it implies a partial deficiency or specific isoform issue.
                        </p>
                        <p>
                            <strong>Important Clarification:</strong> While classic LDH deficiency (Type A) causes *no* lactate rise, this case describes *elevated* lactate. This indicates a more complex scenario. If the question implies a block in the *further metabolism of pyruvate* which then *redirects* to lactate (perhaps through alternative pathways or residual activity), then a Pyruvate Dehydrogenase Complex (PDC) deficiency would lead to elevated pyruvate and thus increased lactate. However, the direct link to the *terminal part of glycolysis* and the explicit mention of lactate strongly points to LDH's role in the lactate pathway. Given the multiple-choice format, LDH is the most direct answer relating to lactate metabolism following glycolysis.
                        </p>
                    `
                },
                {
                    title: 'Case Study: Patient H - Severe Lactic Acidosis in Neonate',
                    content: `
                        <p class="mb-4">
                            Patient H, a newborn, presents with severe and persistent lactic acidosis shortly after birth. The infant also displays hypotonia (poor muscle tone), feeding difficulties, and neurological abnormalities. Despite supportive care, the condition is severe and life-threatening.
                        </p>
                        <p class="mb-4">
                            <strong>Recent Lab Results:</strong>
                        </p>
                        <ul class="list-disc list-inside mb-4">
                            <li><strong>Blood Lactate:</b> Extremely high.</li>
                            <li><strong>Pyruvate:</strong> Also elevated, leading to a very high lactate-to-pyruvate ratio.</li>
                            <li><strong>Ammonia:</strong> Elevated.</li>
                            <li><strong>Urine Organic Acids:</b> May show specific metabolic markers.</li>
                        </ul>
                        <p>
                            This severe lactic acidosis with elevated pyruvate points to a critical block at the entry point of glycolysis products into the mitochondrial oxidative phosphorylation or gluconeogenesis, specifically the conversion of pyruvate to Acetyl-CoA.
                        </p>
                    `,
                    question: 'Considering the severe and persistent lactic acidosis with elevated pyruvate in this neonate, which enzyme complex is most likely deficient?',
                    options: [
                        'Pyruvate Kinase',
                        'Pyruvate Dehydrogenase Complex (PDC)',
                        'Citrate Synthase',
                        'Alpha-Ketoglutarate Dehydrogenase Complex'
                    ],
                    correctAnswer: 'Pyruvate Dehydrogenase Complex (PDC)',
                    explanation: `
                        <p class="font-bold text-gray-800 mb-2">Detailed Explanation:</p>
                        <p class="mb-2">
                            <strong>Disrupted Enzyme:</strong> The severe lactic acidosis, especially when accompanied by elevated pyruvate and neurological symptoms in a neonate, is a hallmark of <strong>Pyruvate Dehydrogenase Complex (PDC) Deficiency</strong>. PDC is a multi-enzyme complex that converts pyruvate (the end-product of glycolysis) into Acetyl-CoA, which then enters the Citric Acid Cycle. A deficiency in PDC prevents pyruvate from being efficiently converted to Acetyl-CoA. This forces pyruvate to be shunted predominantly into lactate (via LDH) to regenerate NAD+, leading to severe lactic acidosis. The brain relies heavily on glucose metabolism, and impaired pyruvate utilization significantly impacts neuronal function, causing the neurological symptoms.
                        </p>
                    `
                },
                {
                    title: 'Case Study: Patient J - Non-Spherocytic Hemolytic Anemia and Splenomegaly',
                    content: `
                        <p class="mb-4">
                            Patient J, a 2-year-old, presents with chronic, non-spherocytic hemolytic anemia and splenomegaly. Unlike typical red blood cell disorders, their red cells are not sphere-shaped. There is no family history of G6PD deficiency. The patient experiences frequent episodes of jaundice.
                        </p>
                        <p class="mb-4">
                            <strong>Recent Lab Results:</strong>
                        </p>
                        <ul class="list-disc list-inside mb-4">
                            <li><strong>Complete Blood Count (CBC):</strong> Hemolytic anemia, elevated reticulocytes.</li>
                            <li><strong>Red Blood Cell Morphology:</strong> Varied, but no spherocytes.</li>
                            <li><strong>Red Blood Cell ATP levels:</b> Significantly decreased.</li>
                            <li><strong>2,3-BPG levels:</strong> Elevated.</li>
                        </ul>
                        <p>
                            The decreased red blood cell ATP combined with elevated 2,3-BPG (2,3-Bisphosphoglycerate), a glycolytic intermediate, strongly points to a block in the later stages of glycolysis that impacts ATP generation without affecting earlier steps.
                        </p>
                    `,
                    question: 'Given the chronic non-spherocytic hemolytic anemia, splenomegaly, decreased red blood cell ATP, and elevated 2,3-BPG, which enzyme deficiency is most likely?',
                    options: [
                        'Hexokinase',
                        'Phosphofructokinase (PFK-1)',
                        'Pyruvate Kinase',
                        'Phosphoglycerate Mutase'
                    ],
                    correctAnswer: 'Pyruvate Kinase',
                    explanation: `
                        <p class="font-bold text-gray-800 mb-2">Detailed Explanation:</p>
                        <p class="mb-2">
                            <strong>Disrupted Enzyme:</strong> This is another classic presentation of <strong>Pyruvate Kinase (PK) Deficiency</strong>. The key here is "non-spherocytic" hemolytic anemia and elevated 2,3-BPG. PK deficiency causes a metabolic block at the end of glycolysis, reducing ATP production. The accumulation of upstream intermediates, including 1,3-bisphosphoglycerate, leads to increased shunting through the Rapoport-Luebering shunt, which produces 2,3-BPG. Elevated 2,3-BPG shifts the oxygen dissociation curve to the right, reducing hemoglobin's affinity for oxygen, which can partially compensate for the anemia but is also a diagnostic marker. The lack of ATP directly impairs the red blood cell's ability to maintain its shape and ion gradients, leading to its premature destruction.
                        </p>
                    `
                },
                {
                    title: 'Case Study: Patient K - Myopathy and Exercise-Induced Myoglobinuria',
                    content: `
                        <p class="mb-4">
                            Patient K, a 25-year-old male, complains of muscle weakness and stiffness, particularly after exercise. He reports instances of dark-colored urine after strenuous workouts, suggesting myoglobinuria (release of myoglobin from damaged muscle cells). He doesn't experience hypoglycemia.
                        </p>
                        <p class="mb-4">
                            <strong>Recent Lab Results (post-exercise):</strong>
                        </p>
                        <ul class="list-disc list-inside mb-4">
                            <li><strong>Creatine Kinase (CK):</strong> Markedly elevated.</li>
                            <li><strong>Blood Lactate:</b> Normal or paradoxically low response to exercise.</li>
                            <li><strong>Muscle Glycogen:</strong> Significantly elevated in biopsy.</li>
                        </ul>
                        <p>
                            The pattern of exercise intolerance, myoglobinuria, elevated CK, and especially the blunted lactate response with high muscle glycogen, points to a primary defect in muscle glycogen breakdown preventing glucose entry into glycolysis during activity.
                        </p>
                    `,
                    question: 'Given these findings, which enzyme deficiency related to glucose or glycogen metabolism is most likely affecting Patient K?',
                    options: [
                        'Phosphoglucomutase',
                        'Glycogen Phosphorylase (Muscle/McArdle Disease)',
                        'Glucose-6-Phosphatase',
                        'Pyruvate Kinase'
                    ],
                    correctAnswer: 'Glycogen Phosphorylase (Muscle/McArdle Disease)',
                    explanation: `
                        <p class="font-bold text-gray-800 mb-2">Detailed Explanation:</p>
                        <p class="mb-2">
                            <strong>Disrupted Enzyme:</strong> Patient K's symptoms are classic for <strong>Glycogen Storage Disease Type V, or McArdle Disease</strong>, caused by a deficiency in <strong>Muscle Glycogen Phosphorylase</strong>. This enzyme is essential for breaking down glycogen into glucose-1-phosphate, which can then be isomerized to glucose-6-phosphate and enter glycolysis. In its absence, muscles cannot effectively utilize their glycogen stores for energy, particularly during anaerobic exercise. This leads to muscle cramps, pain, and rhabdomyolysis (muscle breakdown) manifesting as myoglobinuria. A key diagnostic feature is the *lack* of lactate production during ischemic exercise, because glucose from glycogen cannot enter glycolysis to produce pyruvate, and thus lactate. Blood glucose remains normal as the liver's glycogen phosphorylase (a different isoform) is unaffected.
                        </p>
                    `
                }
            ];
            totalDetectiveCasesDisplay.textContent = detectiveCases.length;


            // --- Quiz Game Functions ---
            function startQuizGame() {
                quizGameActive = true;
                currentQuizQuestionIndex = 0;
                quizGameScore = 0;
                currentGameScoreDisplay.textContent = quizGameScore;
                startGameBtn.classList.add('hidden');
                gameContent.classList.remove('hidden');
                gameScoreBoard.classList.remove('hidden');
                displayQuizQuestion();
            }

            function displayQuizQuestion() {
                gameFeedback.textContent = ''; // Clear previous feedback
                gameAnswerInput.value = ''; // Clear input field
                gameAnswerInput.classList.remove('correct', 'incorrect'); // Clear input feedback
                selectedQuizOption = null; // Clear selected MCQ option

                currentQuizQuestion = quizQuestions[currentQuizQuestionIndex];
                if (!currentQuizQuestion) {
                    endQuizGame();
                    return;
                }

                gameQuestionText.textContent = currentQuizQuestion.question;
                submitGameAnswerBtn.classList.remove('hidden');
                nextGameQuestionBtn.classList.add('hidden'); // Hide next button until answer is checked

                if (currentQuizQuestion.type === 'text' || currentQuizQuestion.type === 'energy-input') {
                    gameInputArea.classList.remove('hidden');
                    gameMcqOptionsArea.classList.add('hidden');
                    gameAnswerInput.type = (currentQuizQuestion.type === 'energy-input') ? 'number' : 'text';
                    gameAnswerInput.focus();
                } else if (currentQuizQuestion.type === 'multiple-choice') {
                    gameInputArea.classList.add('hidden');
                    gameMcqOptionsArea.classList.remove('hidden');
                    gameMcqOptionsArea.innerHTML = ''; // Clear previous options
                    currentQuizQuestion.options.forEach(option => {
                        const button = document.createElement('button');
                        button.textContent = option;
                        button.classList.add('game-option-button');
                        button.addEventListener('click', () => {
                            if (selectedQuizOption) {
                                const prevSelected = gameMcqOptionsArea.querySelector('.game-option-button.selected');
                                if (prevSelected) prevSelected.classList.remove('selected');
                            }
                            button.classList.add('selected');
                            selectedQuizOption = option;
                        });
                        gameMcqOptionsArea.appendChild(button);
                    });
                }
            }

            function checkQuizAnswer() {
                let isCorrect = false;
                let userAnswer;

                if (currentQuizQuestion.type === 'text') {
                    userAnswer = gameAnswerInput.value.trim();
                    isCorrect = userAnswer.toLowerCase() === currentQuizQuestion.correctAnswer.toLowerCase();
                } else if (currentQuizQuestion.type === 'energy-input') {
                    userAnswer = parseInt(gameAnswerInput.value);
                    isCorrect = userAnswer === currentQuizQuestion.correctAnswer;
                } else if (currentQuizQuestion.type === 'multiple-choice') {
                    userAnswer = selectedQuizOption;
                    isCorrect = userAnswer === currentQuizQuestion.correctAnswer;
                }

                if (isCorrect) {
                    gameFeedback.textContent = `Correct! ${currentQuizQuestion.explanation || ''}`;
                    gameFeedback.classList.remove('incorrect');
                    gameFeedback.classList.add('correct');
                    quizGameScore++;
                    currentGameScoreDisplay.textContent = quizGameScore;
                } else {
                    gameFeedback.textContent = `Incorrect. The correct answer was "${currentQuizQuestion.correctAnswer}". ${currentQuizQuestion.explanation || ''}`;
                    gameFeedback.classList.remove('correct');
                    gameFeedback.classList.add('incorrect');
                }

                submitGameAnswerBtn.classList.add('hidden'); // Hide submit button
                nextGameQuestionBtn.classList.remove('hidden'); // Show next button

                // Disable input/options after answer
                if (currentQuizQuestion.type === 'text' || currentQuizQuestion.type === 'energy-input') {
                    gameAnswerInput.disabled = true;
                } else if (currentQuizQuestion.type === 'multiple-choice') {
                    gameMcqOptionsArea.querySelectorAll('.game-option-button').forEach(btn => btn.disabled = true);
                }
            }

            function nextQuizQuestion() {
                currentQuizQuestionIndex++;
                if (currentQuizQuestionIndex < quizQuestions.length) {
                    // Re-enable input/options for the next question
                    gameAnswerInput.disabled = false;
                    gameMcqOptionsArea.querySelectorAll('.game-option-button').forEach(btn => btn.disabled = false);
                    displayQuizQuestion();
                } else {
                    endQuizGame();
                }
            }

            function endQuizGame() {
                quizGameActive = false;
                gameContent.classList.add('hidden');
                gameScoreBoard.classList.add('hidden');
                startGameBtn.classList.remove('hidden');
                gameFeedback.textContent = `Quiz Over! You scored ${quizGameScore} out of ${quizQuestions.length}.`;
                gameFeedback.classList.remove('correct', 'incorrect');
                startGameBtn.textContent = 'Play Quiz Again';
            }

            // --- Drag & Drop Game Functions ---
            function startDragDropGame() {
                dragDropGameActive = true;
                currentDragDropQuestionIndex = 0;
                dragDropGameScore = 0;
                currentDragDropScoreDisplay.textContent = dragDropGameScore;
                startDragDropGameBtn.classList.add('hidden');
                dragDropGameContent.classList.remove('hidden');
                dragDropGameScoreBoard.classList.remove('hidden');

                // Randomly select 3 unique questions for this challenge
                currentDragDropChallengeSet = [];
                const shuffledAllQuestions = [...allDragDropQuestions].sort(() => Math.random() - 0.5);
                for (let i = 0; i < 3 && i < shuffledAllQuestions.length; i++) {
                    currentDragDropChallengeSet.push(shuffledAllQuestions[i]);
                }
                totalDragDropQuestionsDisplay.textContent = currentDragDropChallengeSet.length; // Update total questions display

                displayDragDropQuestion();
            }

            function displayDragDropQuestion() {
                dragDropGameFeedback.textContent = '';
                checkDragDropAnswerBtn.classList.remove('hidden');
                nextDragDropQuestionBtn.classList.add('hidden');

                currentDragDropQuestion = currentDragDropChallengeSet[currentDragDropQuestionIndex]; // Use the challenge set
                if (!currentDragDropQuestion) {
                    endDragDropGame();
                    return;
                }

                moleculeBank.innerHTML = '';
                pathwayDropZonesContainer.innerHTML = '';

                // Shuffle molecules for the bank
                const shuffledMolecules = [...currentDragDropQuestion.molecules].sort(() => Math.random() - 0.5);
                shuffledMolecules.forEach(mol => {
                    const draggable = document.createElement('div');
                    draggable.classList.add('draggable-molecule');
                    draggable.textContent = mol;
                    draggable.setAttribute('draggable', 'true');
                    draggable.setAttribute('data-molecule', mol);
                    moleculeBank.appendChild(draggable);
                });

                // Create pathway segments with drop zones
                currentDragDropQuestion.pathway.forEach((segment, index) => {
                    const pathwaySegmentDiv = document.createElement('div');
                    
                    if (segment.type === 'input' || segment.type === 'output') {
                        pathwaySegmentDiv.classList.add('pathway-segment');
                        const dropZone = document.createElement('div');
                        dropZone.classList.add('drop-zone');
                        dropZone.setAttribute('data-expected', segment.value);
                        dropZone.setAttribute('data-index', index); // Store index for order check
                        dropZone.textContent = `Drop ${segment.type === 'input' ? 'Input' : 'Output'} Here`;
                        dropZone.addEventListener('dragover', dragOver);
                        dropZone.addEventListener('dragleave', dragLeave);
                        dropZone.addEventListener('drop', drop);
                        pathwaySegmentDiv.appendChild(dropZone);
                        pathwayDropZonesContainer.appendChild(pathwaySegmentDiv);
                    } else if (segment.type === 'arrow') {
                        const arrowDiv = document.createElement('div');
                        arrowDiv.classList.add('pathway-arrow-small');
                        arrowDiv.textContent = segment.value;
                        pathwayDropZonesContainer.appendChild(arrowDiv);
                    }
                });

                 // Add drag start listener to dynamically created molecules
                moleculeBank.querySelectorAll('.draggable-molecule').forEach(draggable => {
                    draggable.addEventListener('dragstart', dragStart);
                });
            }

            function dragStart(e) {
                draggedData = e.target.getAttribute('data-molecule');
                e.dataTransfer.setData('text/plain', draggedData);
                e.target.classList.add('opacity-50'); // Visual feedback for dragging
            }

            function dragOver(e) {
                e.preventDefault(); // Allow drop
                e.target.classList.add('drag-over');
            }

            function dragLeave(e) {
                e.target.classList.remove('drag-over');
            }

            function drop(e) {
                e.preventDefault();
                e.target.classList.remove('drag-over');
                
                const droppedMolecule = draggedData;
                const dropZone = e.target;

                // Only allow dropping if the drop zone is empty
                if (dropZone.querySelector('.dropped-molecule')) {
                    return;
                }

                // Append the dropped molecule to the drop zone
                const droppedDiv = document.createElement('div');
                droppedDiv.classList.add('dropped-molecule');
                droppedDiv.textContent = droppedMolecule;
                droppedDiv.setAttribute('data-dropped-molecule', droppedMolecule);
                dropZone.innerHTML = ''; // Clear "Drop Here" text
                dropZone.appendChild(droppedDiv);

                // Remove the molecule from the bank
                const draggableInBank = moleculeBank.querySelector(`.draggable-molecule[data-molecule="${droppedMolecule}"]`);
                if (draggableInBank) {
                    draggableInBank.remove();
                }
                draggedData = null; // Clear dragged data
            }

            function checkDragDropAnswer() {
                let allCorrect = true;
                const dropZones = pathwayDropZonesContainer.querySelectorAll('.drop-zone');
                let userArrangement = [];

                dropZones.forEach(dropZone => {
                    const expectedMolecule = dropZone.getAttribute('data-expected');
                    const droppedMoleculeElement = dropZone.querySelector('.dropped-molecule');
                    const droppedMolecule = droppedMoleculeElement ? droppedMoleculeElement.getAttribute('data-dropped-molecule') : null;
                    
                    if (droppedMolecule === expectedMolecule) {
                        dropZone.classList.add('correct-drop');
                        dropZone.classList.remove('incorrect-drop');
                    } else {
                        dropZone.classList.add('incorrect-drop');
                        dropZone.classList.remove('correct-drop');
                        allCorrect = false;
                    }
                    userArrangement.push(droppedMolecule);
                });

                if (allCorrect) {
                    dragDropGameFeedback.textContent = 'Excellent! All molecules are in the correct place!';
                    dragDropGameFeedback.classList.remove('incorrect');
                    dragDropGameFeedback.classList.add('correct');
                    dragDropGameScore++;
                    currentDragDropScoreDisplay.textContent = dragDropGameScore;
                } else {
                    dragDropGameFeedback.textContent = 'Not quite right. Review the pathway and try again.';
                    dragDropGameFeedback.classList.remove('correct');
                    dragDropGameFeedback.classList.add('incorrect');
                }
                
                // Disable further drops and drags after checking
                moleculeBank.querySelectorAll('.draggable-molecule').forEach(mol => mol.setAttribute('draggable', 'false'));
                dropZones.forEach(dz => {
                    dz.removeEventListener('dragover', dragOver);
                    dz.removeEventListener('dragleave', dragLeave);
                    dz.removeEventListener('drop', drop);
                    dz.classList.remove('drag-over');
                });

                checkDragDropAnswerBtn.classList.add('hidden');
                nextDragDropQuestionBtn.classList.remove('hidden');
            }

            function nextDragDropQuestion() {
                currentDragDropQuestionIndex++;
                if (currentDragDropQuestionIndex < currentDragDropChallengeSet.length) { // Use the challenge set length
                    displayDragDropQuestion();
                } else {
                    endDragDropGame();
                }
            }

            function endDragDropGame() {
                dragDropGameActive = false;
                dragDropGameContent.classList.add('hidden');
                dragDropGameScoreBoard.classList.add('hidden');
                startDragDropGameBtn.classList.remove('hidden');
                dragDropGameFeedback.textContent = `Drag & Drop Game Over! You scored ${dragDropGameScore} out of ${currentDragDropChallengeSet.length}.`; // Use challenge set length
                dragDropGameFeedback.classList.remove('correct', 'incorrect');
                startDragDropGameBtn.textContent = 'Play Drag & Drop Again';
            }

            // --- Detective Game Functions ---
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            function startDetectiveGame() {
                detectiveGameActive = true;
                currentDetectiveCaseIndex = 0;
                detectiveGameScore = 0;
                currentDetectiveScoreDisplay.textContent = detectiveGameScore;
                startDetectiveGameBtn.classList.add('hidden');
                detectiveGameContent.classList.remove('hidden');
                detectiveGameScoreBoard.classList.remove('hidden');

                // Shuffle detective cases
                shuffledDetectiveCases = shuffleArray([...detectiveCases]); // Create a shallow copy and shuffle
                totalDetectiveCasesDisplay.textContent = shuffledDetectiveCases.length; // Update total cases display

                renderDetectiveCase(currentDetectiveCaseIndex);
            }

            const renderDetectiveCase = (index) => {
                const currentCase = shuffledDetectiveCases[index]; // Use shuffled cases
                detectiveCaseStudyTitle.textContent = currentCase.title;
                detectiveCaseStudyContent.innerHTML = currentCase.content;
                detectiveQuestionText.textContent = currentCase.question;

                detectiveRadioGroup.innerHTML = '';
                currentCase.options.forEach(option => {
                    const label = document.createElement('label');
                    const input = document.createElement('input');
                    input.type = 'radio';
                    input.name = 'disruptedStep';
                    input.value = option;
                    label.appendChild(input);
                    label.appendChild(document.createTextNode(option));
                    detectiveRadioGroup.appendChild(label);
                });

                detectiveFeedbackArea.classList.add('hidden');
                detectiveStepFeedbackDiv.className = 'feedback';
                detectiveStepFeedbackDiv.textContent = '';
                detectiveExplanationDiv.innerHTML = '';

                submitDetectiveBtn.classList.remove('hidden');
                nextDetectiveCaseBtn.classList.add('hidden');

                // Re-enable radio options for the current case
                document.querySelectorAll('input[name="disruptedStep"]').forEach(radio => radio.disabled = false);
            };

            const provideDetectiveFeedback = () => {
                const disruptedStepRadios = document.querySelectorAll('input[name="disruptedStep"]');
                let userStep = '';
                disruptedStepRadios.forEach(radio => {
                    if (radio.checked) {
                        userStep = radio.value;
                    }
                });

                if (!userStep) {
                    detectiveStepFeedbackDiv.className = 'feedback incorrect';
                    detectiveStepFeedbackDiv.textContent = 'Please select an answer for the disrupted step.';
                    detectiveFeedbackArea.classList.remove('hidden');
                    detectiveExplanationDiv.innerHTML = '';
                    return;
                }

                const currentCase = shuffledDetectiveCases[currentDetectiveCaseIndex]; // Use shuffled cases
                let stepCorrect = (userStep === currentCase.correctAnswer);

                if (stepCorrect) {
                    detectiveStepFeedbackDiv.className = 'feedback correct';
                    detectiveStepFeedbackDiv.textContent = 'Correct! Your diagnosis is accurate.';
                    detectiveGameScore++;
                    currentDetectiveScoreDisplay.textContent = detectiveGameScore;
                } else {
                    detectiveStepFeedbackDiv.className = 'feedback incorrect';
                    detectiveStepFeedbackDiv.textContent = 'Incorrect. Please review the case study and try again.';
                }

                detectiveExplanationDiv.innerHTML = currentCase.explanation;
                detectiveFeedbackArea.classList.remove('hidden');

                submitDetectiveBtn.classList.add('hidden');
                nextDetectiveCaseBtn.classList.remove('hidden');

                // Disable radio options after submission
                disruptedStepRadios.forEach(radio => radio.disabled = true);
            };

            function nextDetectiveCase() {
                currentDetectiveCaseIndex++;
                if (currentDetectiveCaseIndex < shuffledDetectiveCases.length) { // Use shuffled cases length
                    renderDetectiveCase(currentDetectiveCaseIndex);
                } else {
                    endDetectiveGame();
                }
            }

            function endDetectiveGame() {
                detectiveGameActive = false;
                detectiveGameContent.classList.add('hidden');
                detectiveGameScoreBoard.classList.add('hidden');
                startDetectiveGameBtn.classList.remove('hidden');
                detectiveStepFeedbackDiv.className = 'feedback';
                detectiveStepFeedbackDiv.textContent = `Detective Game Over! You solved ${detectiveGameScore} out of ${shuffledDetectiveCases.length} cases.`; // Use shuffled cases length
                detectiveFeedbackArea.classList.remove('hidden');
                detectiveExplanationDiv.innerHTML = '';
                startDetectiveGameBtn.textContent = 'Play Detective Again';
            }


            // --- Tooltip functionality (Existing) ---
            tooltipElements.forEach(el => {
                el.addEventListener('mouseenter', (e) => {
                    const tooltipText = e.currentTarget.getAttribute('data-tooltip');
                    tooltip.textContent = tooltipText;
                    tooltip.style.opacity = '1';
                    
                    const rect = e.currentTarget.getBoundingClientRect();
                    tooltip.style.left = `${rect.left + rect.width/2 - tooltip.offsetWidth/2}px`;
                    tooltip.style.top = `${rect.top - tooltip.offsetHeight - 10}px`;
                });
                
                el.addEventListener('mouseleave', () => {
                    tooltip.style.opacity = '0';
                });
            });

            // --- Core function to update the displayed step (Existing) ---
            function updateStep(newStepIndex, isAutoplay = false) {
                if (!isAutoplay && autoplayInterval) {
                    clearInterval(autoplayInterval);
                    autoplayInterval = null;
                    autoplayBtn.textContent = 'Autoplay';
                }

                const maxStep = steps.length - 1;
                const minStep = -1; 

                if (newStepIndex < minStep || newStepIndex > maxStep + 1) { 
                    if (isAutoplay && newStepIndex > maxStep && autoplayInterval) {
                        clearInterval(autoplayInterval);
                        autoplayInterval = null;
                        autoplayBtn.textContent = 'Autoplay';
                    }
                    return; 
                }

                currentVisibleStep = newStepIndex;

                steps.forEach(step => {
                    step.classList.remove('visible', 'active');
                    step.style.animation = '';
                });
                pathArrows.forEach(arrow => arrow.classList.remove('visible'));
                pyruvateFate.classList.remove('visible');

                atpTotal = 0;
                nadhTotal = 0;

                for (let i = 0; i <= currentVisibleStep; i++) {
                    const step = steps[i];
                    if (step) {
                        step.classList.add('visible', 'animate-fade-in');
                        step.style.animationDelay = `${i * 0.1}s`;

                        if (i > 0) {
                            const prevPathArrow = pathArrows[i - 1];
                            if (prevPathArrow) {
                                prevPathArrow.classList.add('visible');
                            }
                        }

                        atpTotal += parseInt(step.getAttribute('data-atp') || 0);
                        nadhTotal += parseInt(step.getAttribute('data-nadh') || 0);
                    }
                }

                if (currentVisibleStep >= 0 && currentVisibleStep < steps.length) {
                    steps[currentVisibleStep].classList.add('active');
                    if (window.innerWidth <= 768) {
                        steps[currentVisibleStep].scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });
                    }
                }
                
                if (currentVisibleStep >= 0) {
                    glucose.style.display = 'block';
                    glutChannel.style.display = 'flex';
                    if (currentVisibleStep === 0 && !glucose.dataset.animated) {
                        glucose.style.animation = 'enterCell 2s ease-out forwards';
                        glucose.dataset.animated = 'true';
                    }
                } else {
                    glucose.style.display = 'none';
                    glutChannel.style.display = 'none';
                    glucose.style.animation = '';
                    delete glucose.dataset.animated;
                }

                if (currentVisibleStep === maxStep) {
                    pyruvateFate.classList.add('visible', 'animate-fade-in');
                }

                atpCounter.textContent = atpTotal;
                nadhCounter.textContent = nadhTotal;

                atpCounter.classList.add('animate-shake');
                nadhCounter.classList.add('animate-shake');
                setTimeout(() => {
                    atpCounter.classList.remove('animate-shake');
                    nadhCounter.classList.remove('animate-shake');
                }, 500);
            }

            // --- Button Event Listeners (Existing & New Game Buttons) ---
            nextBtn.addEventListener('click', () => {
                updateStep(currentVisibleStep + 1);
            });

            prevBtn.addEventListener('click', () => {
                updateStep(currentVisibleStep - 1);
            });

            resetBtn.addEventListener('click', () => {
                updateStep(-1);
                atpTotal = 0;
                nadhTotal = 0;
                atpCounter.textContent = atpTotal;
                nadhCounter.textContent = nadhTotal;

                // Reset Quiz game state
                quizGameActive = false;
                quizGameScore = 0;
                currentGameScoreDisplay.textContent = quizGameScore;
                startGameBtn.classList.remove('hidden'); // Show start button
                gameContent.classList.add('hidden'); // Hide game content
                gameScoreBoard.classList.add('hidden'); // Hide game score board
                gameFeedback.textContent = ''; // Clear feedback
                startGameBtn.textContent = 'Start Quiz'; // Reset button text

                // Reset Drag & Drop game state
                dragDropGameActive = false;
                dragDropGameScore = 0;
                currentDragDropScoreDisplay.textContent = dragDropGameScore;
                startDragDropGameBtn.classList.remove('hidden');
                dragDropGameContent.classList.add('hidden');
                dragDropGameScoreBoard.classList.add('hidden');
                dragDropGameFeedback.textContent = '';
                startDragDropGameBtn.textContent = 'Play Drag & Drop Again';
                currentDragDropChallengeSet = []; // Clear the current challenge set

                // Reset Detective game state
                detectiveGameActive = false;
                detectiveGameScore = 0;
                currentDetectiveScoreDisplay.textContent = detectiveGameScore;
                startDetectiveGameBtn.classList.remove('hidden');
                detectiveGameContent.classList.add('hidden');
                detectiveGameScoreBoard.classList.add('hidden');
                detectiveStepFeedbackDiv.textContent = '';
                detectiveExplanationDiv.innerHTML = '';
                detectiveFeedbackArea.classList.add('hidden');
                startDetectiveGameBtn.textContent = 'Start Detective Game';
                document.querySelectorAll('input[name="disruptedStep"]').forEach(radio => radio.disabled = false);


                if (autoplayInterval) {
                    clearInterval(autoplayInterval);
                    autoplayInterval = null;
                    autoplayBtn.textContent = 'Autoplay';
                }
            });

            autoplayBtn.addEventListener('click', () => {
                if (autoplayInterval) {
                    clearInterval(autoplayInterval);
                    autoplayInterval = null;
                    autoplayBtn.textContent = 'Autoplay';
                } else {
                    autoplayBtn.textContent = 'Pause Autoplay';
                    if (currentVisibleStep === steps.length - 1) { 
                         currentVisibleStep = -1;
                    }
                    autoplayInterval = setInterval(() => {
                        updateStep(currentVisibleStep + 1, true);
                    }, 2000);
                }
            });

            // Quiz game button event listeners
            startGameBtn.addEventListener('click', startQuizGame);
            submitGameAnswerBtn.addEventListener('click', checkQuizAnswer);
            nextGameQuestionBtn.addEventListener('click', nextQuizQuestion);
            gameAnswerInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !submitGameAnswerBtn.classList.contains('hidden')) {
                    checkQuizAnswer();
                } else if (e.key === 'Enter' && !nextGameQuestionBtn.classList.contains('hidden')) {
                    nextQuizQuestion();
                }
            });

            // Drag & Drop game button event listeners
            startDragDropGameBtn.addEventListener('click', startDragDropGame);
            checkDragDropAnswerBtn.addEventListener('click', checkDragDropAnswer);
            nextDragDropQuestionBtn.addEventListener('click', nextDragDropQuestion);

            // Detective game button event listeners
            startDetectiveGameBtn.addEventListener('click', startDetectiveGame);
            submitDetectiveBtn.addEventListener('click', provideDetectiveFeedback);
            nextDetectiveCaseBtn.addEventListener('click', nextDetectiveCase);


            steps.forEach((step, index) => {
                step.addEventListener('click', () => {
                    updateStep(index);
                });
            });

            // Keyboard navigation for pathway (separate from game)
            document.addEventListener('keydown', (e) => {
                if (!quizGameActive && !dragDropGameActive && !detectiveGameActive) { // Only navigate pathway if no game is active
                    if (e.key === 'ArrowRight') {
                        updateStep(currentVisibleStep + 1);
                    } else if (e.key === 'ArrowLeft') {
                        updateStep(currentVisibleStep - 1);
                    }
                }
            });

            // Molecule highlighting animation (Existing)
            setInterval(() => {
                const visibleMolecules = document.querySelectorAll('.glycolysis-step.visible .molecule');
                if (visibleMolecules.length > 0) {
                    const randomMolecule = visibleMolecules[Math.floor(Math.random() * visibleMolecules.length)];
                    randomMolecule.classList.add('highlight');
                    setTimeout(() => {
                        randomMolecule.classList.remove('highlight');
                    }, 1500);
                }
            }, 3000);

            // Initial setup: Hide all steps and related elements
            updateStep(-1);

            // Security Layer 2: Monitor the specific div for changes
            const securityDiv = document.getElementById('security-email-check');
            const expectedContent = 'betabiosciences@gmail.com';

            const securityObserver = new MutationObserver((mutationsList, observer) => {
                let compromised = false;

                // Check if the security div itself was removed
                if (!document.body.contains(securityDiv)) {
                    compromised = true;
                } else if (securityDiv.textContent !== expectedContent) {
                    // Check if its content was modified
                    compromised = true;
                }

                if (compromised) {
                    // If compromised, clear the entire body content to "fail" the page
                    document.body.innerHTML = '';
                    // Stop observing as the page is now blank
                    observer.disconnect();
                }
            });

            // Start observing the body for changes in its children (including removal of securityDiv)
            // and subtree for changes within children (including textContent changes of securityDiv)
            securityObserver.observe(document.body, { childList: true, subtree: true, characterData: true });

            // Initial check to ensure the security div is present and correct on load
            if (!securityDiv || securityDiv.textContent !== expectedContent) {
                document.body.innerHTML = '';
            }
        });
    </script>
</body>
</html>
